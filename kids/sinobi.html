<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1V1ELMWFTY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-1V1ELMWFTY');
    </script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å¿ã³è¶³ãƒã‚§ãƒƒã‚«ãƒ¼ / Ninja Stealth Walk</title>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5115190227060860" crossorigin="anonymous"></script>
    
    <style>
        :root {
            --bg: #1a1a2e;
            --card: #ffffff;
            --accent: #e94560; 
            --ninja-blue: #0f3460;
            --shadow: 0 8px 20px rgba(0,0,0,0.3);
        }
        body {
            font-family: "Hiragino Sans", "Meiryo", sans-serif;
            background: #1a1a2e;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            min-height: 100vh; margin: 0; padding: 10px; box-sizing: border-box;
        }

        .container {
            background: var(--card); padding: 20px; border-radius: 30px;
            box-shadow: var(--shadow); text-align: center; width: 100%; max-width: 440px;
            border: 6px solid var(--ninja-blue); box-sizing: border-box; position: relative;
        }

        .btn-reset-trigger {
            position: absolute; top: 15px; right: 15px; font-size: 1.2rem;
            background: none; border: none; cursor: pointer; color: #ccc;
        }

        h1 { font-size: 1.3rem; color: var(--ninja-blue); margin: 0; }
        .sub-title { font-size: 0.8rem; color: #666; margin-bottom: 10px; }

        .record-board {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px;
        }
        .diff-box {
            background: #f8f9fa; border: 1px solid #ddd; border-radius: 15px; padding: 5px;
        }
        .diff-label { font-size: 0.7rem; font-weight: bold; color: var(--ninja-blue); border-bottom: 1px solid #ddd; margin-bottom: 4px; padding-bottom: 2px; }
        .score-row { font-size: 0.65rem; color: #444; margin-bottom: 2px; display: flex; justify-content: space-between; padding: 0 4px; }
        .score-row.best { color: var(--accent); font-weight: bold; border-bottom: 1px dashed #ffcccc; margin-bottom: 4px; }

        .manual-section {
            background: #f0f7ff; padding: 12px; border-radius: 15px;
            text-align: left; font-size: 0.75rem; margin-bottom: 15px; border: 2px dashed var(--ninja-blue);
            color: #333; line-height: 1.4;
        }

        .warning-box {
            font-size: 0.65rem; color: #d63031; background: #ffeaea; padding: 8px; border-radius: 10px; margin-bottom: 15px; text-align: left;
        }

        .diff-selector { display: flex; gap: 8px; margin-bottom: 15px; }
        .diff-btn {
            flex: 1; padding: 8px 4px; border-radius: 15px; border: 2px solid #ddd;
            background: white; cursor: pointer; font-weight: bold; font-size: 0.75rem;
        }
        .diff-btn span { display: block; font-size: 0.6rem; font-weight: normal; }
        .diff-btn.active { border-color: var(--ninja-blue); background: var(--ninja-blue); color: white; }

        /* Game Screen */
        #gameScreen { display: none; position: fixed; inset: 0; background: var(--bg); z-index: 100; flex-direction: column; align-items: center; justify-content: center; color: white; }
        #timerDisplay { font-size: 4rem; font-weight: 800; font-family: monospace; color: #00ffcc; text-shadow: 0 0 15px #00ffcc; margin: 10px 0; }
        .ninja-visual { font-size: 6rem; margin: 15px; }
        
        .meter-bg { width: 70%; height: 15px; background: #333; border-radius: 10px; overflow: hidden; margin-top: 10px; }
        #meterFill { width: 0%; height: 100%; background: linear-gradient(90deg, #00ffcc, #ffcc00, #ff0000); }

        .btn-main { width: 100%; padding: 15px; background: var(--ninja-blue); color: #fff; border: none; border-radius: 20px; font-weight: 800; font-size: 1.1rem; cursor: pointer; box-shadow: 0 5px 0 #081b33; }
        .btn-main:active { transform: translateY(3px); box-shadow: 0 2px 0 #081b33; }
        .btn-exit { position: absolute; top: 15px; right: 15px; padding: 8px 12px; background: rgba(255,255,255,0.1); color: white; border: 1px solid white; border-radius: 10px; font-size: 0.8rem; }

        /* Fail State */
        .fail-bg { background: #600 !important; animation: flash 0.5s infinite; }
        @keyframes flash { 0% { background: #600; } 50% { background: #f00; } 100% { background: #600; } }
        .btn-stop-alarm { background: #fff !important; color: #f00 !important; font-size: 1.5rem; padding: 25px; margin-top: 20px; box-shadow: 0 8px 0 #ccc !important; }

        .footer-copyright { margin-top: 15px; font-size: 0.65rem; color: #999; }
    </style>
</head>
<body>

<div class="container" id="startScreen">
    <button class="btn-reset-trigger" onmousedown="startPress()" onmouseup="endPress()" ontouchstart="startPress()" ontouchend="endPress()">âš™ï¸</button>

    <h1>å¿ã³è¶³ãƒã‚§ãƒƒã‚«ãƒ¼</h1>
    <div class="sub-title">Ninja Stealth Walk Checker</div>

    <div class="record-board">
        <div class="diff-box">
            <div class="diff-label">Easy/æ˜“ã—ã„</div>
            <div class="score-row best">ğŸ† <span id="easy-best">0.00</span></div>
            <div class="score-row">1st <span id="easy-h1">---</span></div>
            <div class="score-row">2nd <span id="easy-h2">---</span></div>
        </div>
        <div class="diff-box">
            <div class="diff-label">Normal/æ™®é€š</div>
            <div class="score-row best">ğŸ† <span id="normal-best">0.00</span></div>
            <div class="score-row">1st <span id="normal-h1">---</span></div>
            <div class="score-row">2nd <span id="normal-h2">---</span></div>
        </div>
        <div class="diff-box">
            <div class="diff-label">Hard/é›£ã—ã„</div>
            <div class="score-row best">ğŸ† <span id="hard-best">0.00</span></div>
            <div class="score-row">1st <span id="hard-h1">---</span></div>
            <div class="score-row">2nd <span id="hard-h2">---</span></div>
        </div>
    </div>
    
    <div class="manual-section">
        <strong>ğŸ“œ ä¿®è¡Œã®æŸ (The Ninja Rules)</strong>
        <div style="margin-top:5px;">ğŸ“± iPhoneã‚’ä¸¡æ‰‹ã§å¹³ã‚‰ã«æŒã¤ (Hold flat)</div>
        <div>ğŸ¥· é™ã‹ã€œã«æ­©ãç¶šã‘ã‚ˆã†ï¼ (Walk quietly)</div>
        <div>ğŸ—‘ï¸ å³ä¸Šã®âš™ï¸ã‚’é•·æŠ¼ã—ã§è¨˜éŒ²ã‚’æ¶ˆã›ã‚‹ã‚ˆ (Long press âš™ï¸ to reset records)</div>
    </div>

    <div class="warning-box">
        <strong>âš ï¸ æ³¨æ„äº‹é … (Notice)</strong><br>
        ãƒ»å±¥æ­´ã‚’æ¶ˆã™ã¨è¨˜éŒ²ã‚‚æ¶ˆãˆã¾ã™ (History deletion erases data)<br>
        ãƒ»ãƒ—ãƒ©ã‚¤ãƒ™ãƒ¼ãƒˆãƒ¢ãƒ¼ãƒ‰ã¯ä¿å­˜ä¸å¯ (Private mode won't save)
    </div>

    <div class="diff-selector">
        <button class="diff-btn active" onclick="selectDiff('easy', 4.0, this)">æ˜“ã—ã„<span>Easy</span></button>
        <button class="diff-btn" onclick="selectDiff('normal', 2.8, this)">æ™®é€š<span>Normal</span></button>
        <button class="diff-btn" onclick="selectDiff('hard', 1.8, this)">é›£ã—ã„<span>Hard</span></button>
    </div>

    <button class="btn-main" onclick="requestPermission()">ä¿® è¡Œ é–‹ å§‹ ! (Start Training)</button>
    <a href="./menu.html" style="display:block; margin-top:12px; color:#aaa; text-decoration:none; font-size:0.75rem;">â† ã‚‚ã©ã‚‹ (Back)</a>
    
    <div class="footer-copyright">Â© 2026 KuniFami Soft Studio. All Rights Reserved.</div>
</div>

<div id="gameScreen">
    <button id="exitBtn" class="btn-exit" onclick="stopGame()">Quit/è¾ã‚ã‚‹</button>
    <div id="statusText" style="font-size: 1.2rem; color: #00ffcc; font-weight: bold; text-align:center;">READY...</div>
    <div id="timerDisplay">0.00s</div>
    <div id="ninjaIcon" class="ninja-visual">ğŸ¥·</div>
    <div id="meterContainer" class="meter-bg"><div id="meterFill"></div></div>
    <button id="stopAlarmBtn" class="btn-main btn-stop-alarm" style="display:none;" onclick="stopGame()">æ­¢ã‚ã‚‹ / STOP ALARM</button>
</div>

<script>
    let timer = 0, timerId = null, isGaming = false, canCheckFail = false;
    let currentMode = 'easy';
    let threshold = 4.0;
    let pressTimer;
    let audioCtx = null;
    let alarmOsc = null;
    let alarmGain = null;

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        }
    }

    function startAlarmLoop() {
        if (!audioCtx) return;
        
        alarmOsc = audioCtx.createOscillator();
        alarmGain = audioCtx.createGain();
        
        alarmOsc.type = 'sawtooth';
        // ã‚µã‚¤ãƒ¬ãƒ³ã®ã‚ˆã†ã«å‘¨æ³¢æ•°ã‚’ä¸Šä¸‹ã•ã›ã‚‹
        alarmOsc.frequency.setValueAtTime(440, audioCtx.currentTime);
        
        // éŸ³é‡ã‚’æœ€å¤§é™ã«è¿‘ã
        alarmGain.gain.setValueAtTime(0.6, audioCtx.currentTime);
        
        alarmOsc.connect(alarmGain);
        alarmGain.connect(audioCtx.destination);
        
        alarmOsc.start();
        
        // å‘¨æ³¢æ•°ã‚’æºã‚‰ã—ã¦ã‚µã‚¤ãƒ¬ãƒ³éŸ³ã‚’ä½œã‚‹
        const interval = 0.5;
        setInterval(() => {
            if (alarmOsc) {
                const now = audioCtx.currentTime;
                alarmOsc.frequency.exponentialRampToValueAtTime(880, now + interval);
                alarmOsc.frequency.exponentialRampToValueAtTime(440, now + interval * 2);
            }
        }, interval * 2000);
    }

    function stopAlarmSound() {
        if (alarmOsc) {
            alarmOsc.stop();
            alarmOsc.disconnect();
            alarmOsc = null;
        }
        if (alarmGain) {
            alarmGain.disconnect();
            alarmGain = null;
        }
    }

    function startPress() {
        pressTimer = window.setTimeout(function() {
            if(confirm("ã™ã¹ã¦ã®è¨˜éŒ²ã‚’æ¶ˆå»ã—ã¾ã™ã‹ï¼Ÿ\nDo you want to reset all records?")) {
                localStorage.clear();
                alert("è¨˜éŒ²ã‚’æ¶ˆå»ã—ã¾ã—ãŸã€‚/ Records reset.");
                location.reload();
            }
        }, 3000);
    }
    function endPress() { clearTimeout(pressTimer); }

    function getStoredData(mode) {
        const best = localStorage.getItem(`ninja_best_${mode}`) || 0;
        const history = JSON.parse(localStorage.getItem(`ninja_history_${mode}`)) || [];
        return { best, history };
    }

    function updateDisplay() {
        ['easy', 'normal', 'hard'].forEach(mode => {
            const data = getStoredData(mode);
            document.getElementById(`${mode}-best`).innerText = parseFloat(data.best).toFixed(2);
            document.getElementById(`${mode}-h1`).innerText = data.history[0] ? parseFloat(data.history[0]).toFixed(2) : "---";
            document.getElementById(`${mode}-h2`).innerText = data.history[1] ? parseFloat(data.history[1]).toFixed(2) : "---";
        });
    }
    updateDisplay();

    function selectDiff(mode, val, btn) {
        currentMode = mode; threshold = val;
        document.querySelectorAll('.diff-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function requestPermission() {
        initAudio();
        if (typeof DeviceMotionEvent !== 'undefined' && typeof DeviceMotionEvent.requestPermission === 'function') {
            DeviceMotionEvent.requestPermission().then(state => { if (state === 'granted') startGame(); });
        } else { startGame(); }
    }

    function startGame() {
        isGaming = true; canCheckFail = false; timer = 0;
        document.getElementById('startScreen').style.display = 'none';
        document.getElementById('gameScreen').style.display = 'flex';
        document.getElementById('gameScreen').classList.remove('fail-bg');
        document.getElementById('stopAlarmBtn').style.display = 'none';
        document.getElementById('exitBtn').style.display = 'block';
        document.getElementById('meterContainer').style.display = 'block';
        document.getElementById('timerDisplay').innerText = "0.00s";
        document.getElementById('statusText').innerText = "READY...";
        document.getElementById('ninjaIcon').innerText = "ğŸ¥·";

        setTimeout(() => {
            if(!isGaming) return;
            canCheckFail = true;
            document.getElementById('statusText').innerText = "WALK SILENTLY! / é™ã‹ã«æ­©ã‘ï¼";
            timerId = setInterval(() => {
                timer += 0.01;
                document.getElementById('timerDisplay').innerText = timer.toFixed(2) + "s";
            }, 10);
        }, 800);

        window.removeEventListener('devicemotion', handleMotion);
        window.addEventListener('devicemotion', handleMotion);
    }

    function handleMotion(event) {
        if (!isGaming) return;
        const acc = event.accelerationIncludingGravity;
        if (!acc || acc.x === null) return;
        const shake = Math.abs(Math.sqrt(acc.x**2 + acc.y**2 + acc.z**2) - 9.8);
        document.getElementById('meterFill').style.width = Math.min((shake / threshold) * 100, 100) + "%";
        if (canCheckFail && shake > threshold) failGame();
    }

    function failGame() {
        isGaming = false; clearInterval(timerId);
        window.removeEventListener('devicemotion', handleMotion);
        
        // å¤±æ•—UIã«åˆ‡ã‚Šæ›¿ãˆ
        document.getElementById('gameScreen').classList.add('fail-bg');
        document.getElementById('ninjaIcon').innerText = "ğŸ’¥";
        document.getElementById('statusText').innerText = "ä¿®è¡Œå¤±æ•—ï¼è¶³éŸ³ãŒã†ã‚‹ã•ã„ãï¼\nTRAINING FAILED!";
        document.getElementById('statusText').style.color = "#fff";
        document.getElementById('exitBtn').style.display = 'none';
        document.getElementById('meterContainer').style.display = 'none';
        document.getElementById('stopAlarmBtn').style.display = 'block';
        
        startAlarmLoop();

        const data = getStoredData(currentMode);
        if (timer > data.best) localStorage.setItem(`ninja_best_${currentMode}`, timer);
        data.history.unshift(timer);
        if (data.history.length > 2) data.history.pop();
        localStorage.setItem(`ninja_history_${currentMode}`, JSON.stringify(data.history));

        updateDisplay();
    }

    function stopGame() {
        isGaming = false; if (timerId) clearInterval(timerId);
        stopAlarmSound();
        window.removeEventListener('devicemotion', handleMotion);
        document.getElementById('startScreen').style.display = 'block';
        document.getElementById('gameScreen').style.display = 'none';
    }
</script>
</body>
</html>
