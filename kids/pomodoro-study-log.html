<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1V1ELMWFTY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-1V1ELMWFTY');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›†ä¸­ãƒã‚¹ã‚¿ãƒ¼ Pro + Backup</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4a90e2; --accent: #ff00ff; --bg: #111; --card: #ffffff; }
        body { font-family: "Hiragino Sans", sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 10px; box-sizing: border-box; }
        .card { background: var(--card); padding: 20px; border-radius: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); text-align: center; width: 100%; max-width: 450px; border: 4px solid #fff; margin-bottom: 15px; box-sizing: border-box; }
        .pomo-guide { text-align: left; font-size: 0.85rem; line-height: 1.6; color: #444; background: #f9f9f9; border-radius: 20px; padding: 15px; margin-bottom: 15px; border: 1px solid #eee; }
        .pomo-guide summary { font-weight: bold; color: var(--primary); cursor: pointer; outline: none; margin-bottom: 5px; }
        .pomo-guide h4 { border-left: 4px solid var(--accent); padding-left: 8px; margin: 15px 0 8px 0; color: #333; font-size: 0.9rem; }
        .timer-display { font-size: 4.5rem; font-weight: 900; color: var(--primary); margin: 10px 0; font-variant-numeric: tabular-nums; }
        .tag-input { width: 90%; padding: 12px; border-radius: 12px; border: 2px solid #ddd; font-size: 1rem; text-align: center; margin-bottom: 10px; }
        .btn-main { width: 100%; padding: 16px; background: var(--accent); color: #fff; border: none; border-radius: 20px; font-weight: 800; font-size: 1.2rem; cursor: pointer; box-shadow: 0 5px 0 #c000c0; }
        .btn-main:active { transform: translateY(3px); box-shadow: 0 2px 0 #c000c0; }
        .btn-tool { background: #95a5a6; color: white; padding: 8px 12px; border-radius: 10px; border: none; font-size: 0.75rem; cursor: pointer; font-weight: bold; }
        .btn-danger { background: #ff4757; }
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 25px; width: 85%; max-width: 350px; text-align: center; }
        .chart-container { height: 280px; margin-top: 10px; }
        .backup-area { display: flex; gap: 5px; flex-wrap: wrap; justify-content: center; margin-top: 10px; border-top: 1px solid #eee; padding-top: 10px; }
        .instruction { font-size: 0.75rem; color: #666; margin-bottom: 5px; }
    </style>
</head>
<body>

<div class="card">
    <div class="pomo-guide">
        <details>
            <summary>ğŸ… ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ã¨ã¯ï¼Ÿ / What is Pomodoro?</summary>
            <p>ã€Œ25åˆ†å‹‰å¼·ã€ã¯ã€25åˆ†é›†ä¸­ï¼‹5åˆ†ä¼‘æ†©ã‚’ç¹°ã‚Šè¿”ã™æ™‚é–“ç®¡ç†è¡“ã§ã™ã€‚</p>
            <details>
                <summary>ğŸ“ ã‚„ã‚Šæ–¹</summary>
                <h4>1. ã‚¿ã‚¹ã‚¯ã‚’æ±ºã‚ã‚‹</h4><p>ã‚„ã‚‹ã¹ãå†…å®¹ã‚’æ˜ç¢ºã«ã—ã¾ã™ã€‚</p>
                <h4>2. 25åˆ†é›†ä¸­</h4><p>ã‚¿ã‚¤ãƒãƒ¼ã‚’ã‚»ãƒƒãƒˆã—é–‹å§‹ï¼</p>
                <h4>3. 5åˆ†ä¼‘æ†©</h4><p>ã‚¹ãƒãƒ›ã¯è¦‹ãªã„ã®ãŒã‚³ãƒ„ï¼</p>
                <h4>4. é•·ã‚ã®ä¼‘æ†©</h4><p>4å›çµ‚ã‚ã£ãŸã‚‰30åˆ†ç¨‹ä¼‘ã¿ã¾ã™ã€‚</p>
            </details>
        </details>
    </div>
    <input type="text" id="studyTag" class="tag-input" list="tagHistory" placeholder="ä¾‹ï¼šæ•°å­¦ã€è‹±èª">
    <datalist id="tagHistory"></datalist>
    <div id="statusLabel" style="font-weight: bold; color: #666;">é›†ä¸­ã‚¿ã‚¤ãƒ  (ãƒ†ã‚¹ãƒˆ5ç§’)</div>
    <div class="timer-display" id="timerDisplay">00:05</div>
    <button id="startBtn" class="btn-main" onclick="toggleTimer()">ã‚¹ã‚¿ãƒ¼ãƒˆï¼</button>
</div>

<div class="card">
    <div class="instruction">ğŸ’¡ ã‚°ãƒ©ãƒ•ã®ãƒãƒ¼ã‚’ã‚¿ãƒƒãƒ—ã—ã¦ã€Œãã®æ—¥ã€ã‚’å‰Šé™¤</div>
    <div style="display:flex; justify-content: center; gap:5px; margin-bottom:10px;">
        <button class="btn-tool" onclick="changeRange(1, this)">ä»Šæ—¥</button>
        <button class="btn-tool" onclick="changeRange(7, this)">1é€±</button>
        <button class="btn-tool" onclick="changeRange(30, this)">1æœˆ</button>
    </div>
    <div class="chart-container"><canvas id="pomoChart"></canvas></div>
    
    <div style="margin-top:15px; display:flex; gap:8px; justify-content: center;">
        <button class="btn-tool btn-danger" id="delTargetBtn" onclick="openDeleteModal()" style="display:none; flex:1;">ğŸ—‘ å‰Šé™¤ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã‚’é–‹ã</button>
    </div>

    <div class="backup-area">
        <button class="btn-tool" style="background:#27ae60;" onclick="exportData()">ğŸ’¾ ä¿å­˜</button>
        <button class="btn-tool" style="background:#2980b9;" onclick="document.getElementById('importFile').click()">ğŸ“‚ å¾©å…ƒ</button>
        <button class="btn-tool" style="background:#e67e22;" onclick="generateTestYearlyData()">ğŸ§ª 1å¹´åˆ†ç”Ÿæˆ</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3 id="delTagTitle" style="color:var(--accent); margin:0;">ã‚¿ã‚°å‰Šé™¤</h3>
        <p id="delDateInfo" style="font-size:0.9rem; font-weight:bold; margin:10px 0;"></p>
        <p id="delMaxInfo" style="font-size:0.8rem; color:#666;"></p>
        <div id="sliderBox">
            <label><span id="delValDisplay">25</span> åˆ† å‰Šé™¤</label>
            <input type="range" id="delSlider" style="width:100%" step="25" min="25">
        </div>
        <div style="margin:10px 0;"><label><input type="checkbox" id="delAllCheck" onchange="toggleDelAll(this)"> å…¨ã¦å‰Šé™¤</label></div>
        <div style="display:flex; gap:10px;">
            <button class="btn-tool" style="flex:1; background:#ccc;" onclick="closeDeleteModal()">æˆ»ã‚‹</button>
            <button class="btn-tool btn-danger" style="flex:1;" onclick="executeDelete()">å®Ÿè¡Œ</button>
        </div>
    </div>
</div>

<script>
    const STUDY_TIME = 5; 
    const BREAK_TIME = 3;
    let timeLeft = STUDY_TIME;
    let timerIdx = null;
    let isBreak = false;
    let dailyStats = JSON.parse(localStorage.getItem('focus_master_stats')) || {};
    let tagHistory = JSON.parse(localStorage.getItem('focus_master_tags')) || [];
    let currentRange = 7;
    let myChart = null;
    
    // é¸æŠã•ã‚ŒãŸæƒ…å ±ã‚’ä¿æŒ
    let selectedTag = null;
    let selectedDate = null;
    let chartDates = []; // ã‚°ãƒ©ãƒ•ã®å„Indexã«å¯¾å¿œã™ã‚‹å®Ÿéš›ã®æ—¥ä»˜(YYYY-MM-DD)

    function toggleTimer() {
        const btn = document.getElementById('startBtn');
        if (timerIdx) {
            clearInterval(timerIdx); timerIdx = null;
            btn.textContent = "å†é–‹";
        } else {
            btn.textContent = "ä¸€æ™‚åœæ­¢";
            timerIdx = setInterval(() => {
                timeLeft--; updateTimerDisplay();
                if (timeLeft <= 0) { clearInterval(timerIdx); timerIdx = null; handleTimerEnd(); }
            }, 1000);
        }
    }

    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60); const s = timeLeft % 60;
        document.getElementById('timerDisplay').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function handleTimerEnd() {
        const tag = document.getElementById('studyTag').value.trim() || "ãã®ä»–";
        const today = new Date().toISOString().split('T')[0];
        if (!isBreak) {
            if (!dailyStats[today]) dailyStats[today] = {};
            dailyStats[today][tag] = (dailyStats[today][tag] || 0) + 25;
            if (!tagHistory.includes(tag)) tagHistory.push(tag);
            save(); alert(`ã€${tag}ã€‘å®Œäº†ï¼`); isBreak = true; timeLeft = BREAK_TIME;
        } else {
            alert("ä¼‘æ†©çµ‚äº†ï¼"); isBreak = false; timeLeft = STUDY_TIME;
        }
        updateStatusUI(); updateTimerDisplay(); renderChart(); updateTagList();
        document.getElementById('startBtn').textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆï¼";
    }

    function updateStatusUI() {
        const label = document.getElementById('statusLabel');
        label.textContent = isBreak ? "ä¼‘æ†©ä¸­" : "é›†ä¸­ã‚¿ã‚¤ãƒ ";
        label.style.color = isBreak ? "#f39c12" : "#4a90e2";
    }

    function renderChart() {
        const ctx = document.getElementById('pomoChart').getContext('2d');
        const labels = []; chartDates = []; 
        const datasetsMap = {}; const end = new Date();
        
        for (let i = currentRange - 1; i >= 0; i--) {
            const d = new Date(); d.setDate(end.getDate() - i);
            const ds = d.toISOString().split('T')[0];
            chartDates.push(ds); // Indexã¨æ—¥ä»˜ã‚’ç´ä»˜ã‘
            labels.push(`${d.getMonth()+1}/${d.getDate()}`);
            tagHistory.forEach(tag => {
                if (!datasetsMap[tag]) datasetsMap[tag] = [];
                datasetsMap[tag].push((dailyStats[ds] && dailyStats[ds][tag]) || 0);
            });
        }
        const datasets = Object.keys(datasetsMap).map((tag, idx) => ({
            label: tag, data: datasetsMap[tag], backgroundColor: `hsl(${idx * 137.5}, 70%, 60%)`, borderRadius: 5
        }));

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar', data: { labels, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { stacked: true }, y: { stacked: true, beginAtZero: true } },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const { datasetIndex, index } = elements[0];
                        selectedTag = myChart.data.datasets[datasetIndex].label;
                        selectedDate = chartDates[index]; // ã‚¯ãƒªãƒƒã‚¯ã•ã‚ŒãŸå ´æ‰€ã®æ—¥ä»˜ã‚’ç‰¹å®š
                        const btn = document.getElementById('delTargetBtn');
                        btn.style.display = 'block';
                        btn.textContent = `ğŸ—‘ ${selectedDate} ã® ${selectedTag} ã‚’å‰Šé™¤`;
                    }
                }
            }
        });
    }

    function openDeleteModal() {
        if (!selectedTag || !selectedDate || !dailyStats[selectedDate] || !dailyStats[selectedDate][selectedTag]) {
            return alert("é¸æŠã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚");
        }
        const maxTime = dailyStats[selectedDate][selectedTag];
        document.getElementById('delTagTitle').textContent = `ã€Œ${selectedTag}ã€ã‚’å‰Šé™¤`;
        document.getElementById('delDateInfo').textContent = `å¯¾è±¡æ—¥: ${selectedDate}`;
        document.getElementById('delMaxInfo').textContent = `è¨˜éŒ²æ™‚é–“: ${maxTime}åˆ†`;
        
        const slider = document.getElementById('delSlider');
        slider.max = maxTime; slider.value = 25; slider.disabled = false;
        document.getElementById('delValDisplay').textContent = 25;
        document.getElementById('delAllCheck').checked = false;
        slider.oninput = function() { document.getElementById('delValDisplay').textContent = this.value; };
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function toggleDelAll(chk) {
        const slider = document.getElementById('delSlider');
        if (chk.checked) { slider.value = dailyStats[selectedDate][selectedTag]; slider.disabled = true; }
        else { slider.disabled = false; slider.value = 25; }
        document.getElementById('delValDisplay').textContent = slider.value;
    }

    function executeDelete() {
        const amount = parseInt(document.getElementById('delSlider').value);
        if (confirm(`${selectedDate} ã® ${selectedTag} ã‚’ ${amount}åˆ† å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            dailyStats[selectedDate][selectedTag] -= amount;
            if (dailyStats[selectedDate][selectedTag] <= 0) delete dailyStats[selectedDate][selectedTag];
            save(); renderChart(); closeDeleteModal();
            document.getElementById('delTargetBtn').style.display = 'none';
        }
    }

    function closeDeleteModal() { document.getElementById('deleteModal').style.display = 'none'; }

    // --- ãã®ä»–æ©Ÿèƒ½ (ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ»ãƒ†ã‚¹ãƒˆç”Ÿæˆç­‰) ---
    function generateTestYearlyData() {
        if(!confirm("1å¹´åˆ†ã®ãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆã—ã¾ã™ã‹ï¼Ÿ")) return;
        const stats = {}; const tags = ["æ•°å­¦", "è‹±èª", "ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°", "èª­æ›¸", "ãã®ä»–"];
        const endDate = new Date();
        for (let i = 0; i < 365; i++) {
            const d = new Date(); d.setDate(endDate.getDate() - i);
            const ds = d.toISOString().split('T')[0];
            stats[ds] = {};
            const activeTags = [...tags].sort(() => 0.5 - Math.random()).slice(0, 3);
            activeTags.forEach(tag => { stats[ds][tag] = (Math.floor(Math.random() * 5) + 1) * 25; });
        }
        dailyStats = stats; tagHistory = tags; save(); renderChart(); updateTagList();
    }

    function exportData() {
        const data = JSON.stringify({ stats: dailyStats, tags: tagHistory });
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `pomo_backup_${new Date().toISOString().split('T')[0]}.json`;
        a.click();
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const imported = JSON.parse(e.target.result);
                dailyStats = imported.stats; tagHistory = imported.tags;
                save(); renderChart(); updateTagList(); alert("å¾©å…ƒå®Œäº†ï¼");
            } catch (err) { alert("ç„¡åŠ¹ãªãƒ•ã‚¡ã‚¤ãƒ«ã§ã™"); }
        };
        reader.readAsText(file);
    }

    function save() {
        localStorage.setItem('focus_master_stats', JSON.stringify(dailyStats));
        localStorage.setItem('focus_master_tags', JSON.stringify(tagHistory));
    }

    function changeRange(days, btn) {
        currentRange = days;
        document.querySelectorAll('.btn-tool').forEach(b => b.classList.remove('btn-active'));
        btn.classList.add('btn-active'); renderChart();
    }

    function updateTagList() {
        const list = document.getElementById('tagHistory');
        list.innerHTML = tagHistory.map(t => `<option value="${t}">`).join('');
    }

    window.onload = () => { renderChart(); updateTagList(); updateTimerDisplay(); };
</script>
</body>
</html>
