<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1V1ELMWFTY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-1V1ELMWFTY');
    </script>
    
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5115190227060860" crossorigin="anonymous"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›†ä¸­ãƒã‚¹ã‚¿ãƒ¼ Pro + Backup</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4a90e2; --accent: #ff00ff; --bg: #111; --card: #ffffff; }
        body { font-family: "Hiragino Sans", sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 10px; box-sizing: border-box; min-height: 100vh; color: #fff; }
        
        /* ã‚«ãƒ¼ãƒ‰è¨­å®š */
        .card { background: var(--card); padding: 20px; border-radius: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); text-align: center; width: 100%; max-width: 480px; border: 4px solid #fff; margin-bottom: 15px; box-sizing: border-box; color: #333; }
        
        .timer-display { font-size: 4.5rem; font-weight: 900; color: var(--primary); margin: 10px 0; font-variant-numeric: tabular-nums; }
        .tag-input { width: 90%; padding: 12px; border-radius: 12px; border: 2px solid #ddd; font-size: 1rem; text-align: center; margin-bottom: 10px; -webkit-appearance: none; }
        
        .btn-main { width: 100%; padding: 18px; background: var(--accent); color: #fff; border: none; border-radius: 20px; font-weight: 800; font-size: 1.3rem; cursor: pointer; box-shadow: 0 5px 0 #c000c0; }
        .btn-main:active { transform: translateY(3px); box-shadow: 0 2px 0 #c000c0; }
        .btn-tool { background: #95a5a6; color: white; padding: 12px 16px; border-radius: 10px; border: none; font-size: 0.85rem; cursor: pointer; font-weight: bold; }
        .btn-danger { background: #ff4757; }
        
        /* ãƒ¢ãƒ¼ãƒ€ãƒ« */
        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 35px; border-radius: 30px; width: 90%; max-width: 400px; text-align: center; color: #333; }
        
        .chart-container { height: 280px; margin-top: 10px; }
        .backup-area { display: flex; gap: 8px; flex-wrap: wrap; justify-content: center; margin-top: 10px; border-top: 1px solid #eee; padding-top: 15px; }
        
        /* ãƒ•ãƒƒã‚¿ãƒ¼ã‚¨ãƒªã‚¢ */
        .footer-area { width: 100%; max-width: 480px; text-align: center; margin-top: 25px; padding-bottom: 30px; }
        .footer-link { display: inline-block; color: #fff; text-decoration: none; font-size: 1.1rem; font-weight: bold; padding: 15px 30px; background: #444; border: 2px solid #666; border-radius: 15px; margin-bottom: 20px; }
        .footer-link:active { background: #666; }
        .copyright { color: #eee; font-size: 0.9rem; }

        /* ã‚¢ãƒ©ãƒ¼ãƒ åœæ­¢ãƒœã‚¿ãƒ³ */
        .btn-alarm-stop { background: #ff4757; font-size: 1.8rem; padding: 25px; animation: pulse 1s infinite; margin-top: 20px; width: 100%; box-shadow: 0 6px 0 #b33030; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="card">
    <input type="text" id="studyTag" class="tag-input" list="tagHistory" placeholder="ä¾‹ï¼šæ•°å­¦ã€è‹±èª">
    <datalist id="tagHistory"></datalist>
    <div id="statusLabel" style="font-weight: bold; color: #666;">é›†ä¸­ã‚¿ã‚¤ãƒ  (Focus Time)</div>
    <div class="timer-display" id="timerDisplay">00:05</div>
    <button id="startBtn" class="btn-main" onclick="toggleTimer()">ã‚¹ã‚¿ãƒ¼ãƒˆï¼ / START</button>
</div>

<div class="card">
    <div style="display:flex; justify-content: center; gap:5px; margin-bottom:10px;">
        <button class="btn-tool" onclick="changeRange(1, this)">ä»Šæ—¥</button>
        <button class="btn-tool" onclick="changeRange(7, this)">1é€±</button>
        <button class="btn-tool" onclick="changeRange(30, this)">1æœˆ</button>
    </div>
    <div class="chart-container"><canvas id="pomoChart"></canvas></div>
    <button class="btn-tool btn-danger" id="delTargetBtn" onclick="openDeleteModal()" style="display:none; width:100%; margin-top:10px; padding: 15px;">ğŸ—‘ ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã™ã‚‹</button>

    <div class="backup-area">
        <button class="btn-tool" style="background:#27ae60;" onclick="exportData()">ğŸ’¾ ä¿å­˜</button>
        <button class="btn-tool" style="background:#2980b9;" onclick="document.getElementById('importFile').click()">ğŸ“‚ å¾©å…ƒ</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
</div>

<div class="footer-area">
    <a href="./menu.html" class="footer-link">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ã‚‚ã©ã‚‹ (Back)</a>
    <div class="copyright">
        Â© 2026 KuniFami Soft Studio. <br>All Rights Reserved.
    </div>
</div>

<div id="deleteModal" class="modal">
    <div class="modal-content">
        <h3 id="delTagTitle" style="color:var(--accent); margin-top:0;">ã‚¿ã‚°å‰Šé™¤</h3>
        <p id="delDateInfo" style="font-weight:bold;"></p>
        <div style="margin:20px 0;">
            <label><span id="delValDisplay">25</span> åˆ† å‰Šé™¤</label>
            <input type="range" id="delSlider" style="width:100%" step="25" min="25">
        </div>
        <div style="margin:15px 0;"><label><input type="checkbox" id="delAllCheck" onchange="toggleDelAll(this)"> å…¨ã¦å‰Šé™¤ (Delete All)</label></div>
        <div style="display:flex; gap:10px;">
            <button class="btn-tool" style="flex:1; background:#ccc;" onclick="closeDeleteModal()">æˆ»ã‚‹</button>
            <button class="btn-tool btn-danger" style="flex:1;" onclick="executeDelete()">å®Ÿè¡Œ</button>
        </div>
    </div>
</div>

<div id="alarmModal" class="modal">
    <div class="modal-content">
        <h2 id="alarmTitle" style="color:var(--primary); font-size:2.2rem; margin:0;">æ™‚é–“ã§ã™ï¼</h2>
        <p style="font-size:1.2rem; margin:15px 0;">ãŠç–²ã‚Œæ§˜ã§ã—ãŸã€‚</p>
        <button class="btn-main btn-alarm-stop" onclick="stopAlarm()">æ­¢ã‚ã‚‹ / OK</button>
    </div>
</div>

<script>
    const STUDY_TIME = 5; // ãƒ†ã‚¹ãƒˆç”¨5ç§’
    const BREAK_TIME = 3; // ãƒ†ã‚¹ãƒˆç”¨3ç§’
    
    let timeLeft = STUDY_TIME;
    let timerIdx = null;
    let isBreak = false;
    let dailyStats = JSON.parse(localStorage.getItem('focus_master_stats')) || {};
    let tagHistory = JSON.parse(localStorage.getItem('focus_master_tags')) || [];
    let currentRange = 7;
    let myChart = null;
    let alarmInterval = null;
    let selectedTag = null;
    let selectedDate = null;
    let chartDates = [];

    let audioCtx = null;

    function initAudio() {
        if (!audioCtx) {
            audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            gain.gain.value = 0;
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            osc.start(0); osc.stop(0.1);
        }
        if (audioCtx.state === 'suspended') audioCtx.resume();
    }

    function playNotificationSound() {
        if (!audioCtx) return;
        const oscillator = audioCtx.createOscillator();
        const gainNode = audioCtx.createGain();
        oscillator.connect(gainNode);
        gainNode.connect(audioCtx.destination);
        oscillator.type = 'sine';
        oscillator.frequency.setValueAtTime(880, audioCtx.currentTime);
        gainNode.gain.setValueAtTime(0.3, audioCtx.currentTime);
        oscillator.start(); oscillator.stop(audioCtx.currentTime + 0.5);
    }

    function toggleTimer() {
        initAudio();
        const btn = document.getElementById('startBtn');
        if (timerIdx) {
            clearInterval(timerIdx); timerIdx = null;
            btn.textContent = "å†é–‹ / Resume";
        } else {
            btn.textContent = "ä¸€æ™‚åœæ­¢ / Pause";
            timerIdx = setInterval(() => {
                timeLeft--; updateTimerDisplay();
                if (timeLeft <= 0) { 
                    clearInterval(timerIdx); timerIdx = null; 
                    startAlarmLoop();
                }
            }, 1000);
        }
    }

    function startAlarmLoop() {
        document.getElementById('alarmTitle').textContent = isBreak ? "ä¼‘æ†©çµ‚äº†ï¼" : "é›†ä¸­çµ‚äº†ï¼";
        document.getElementById('alarmModal').style.display = 'flex';
        const trigger = () => {
            playNotificationSound();
            if (navigator.vibrate) navigator.vibrate([500, 200, 500]);
        };
        trigger();
        alarmInterval = setInterval(trigger, 1500);
    }

    function stopAlarm() {
        if (alarmInterval) { clearInterval(alarmInterval); alarmInterval = null; }
        document.getElementById('alarmModal').style.display = 'none';
        handleTimerEnd(); 
    }

    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60); const s = timeLeft % 60;
        document.getElementById('timerDisplay').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }

    function handleTimerEnd() {
        const tag = document.getElementById('studyTag').value.trim() || "ãã®ä»–";
        const today = new Date().toISOString().split('T')[0];
        if (!isBreak) {
            if (!dailyStats[today]) dailyStats[today] = {};
            dailyStats[today][tag] = (dailyStats[today][tag] || 0) + 25;
            if (!tagHistory.includes(tag)) tagHistory.push(tag);
            save(); isBreak = true; timeLeft = BREAK_TIME;
        } else {
            isBreak = false; timeLeft = STUDY_TIME;
        }
        updateStatusUI(); updateTimerDisplay(); renderChart(); updateTagList();
        document.getElementById('startBtn').textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆï¼ / START";
    }

    function updateStatusUI() {
        const label = document.getElementById('statusLabel');
        label.textContent = isBreak ? "ä¼‘æ†©ä¸­ (Resting)" : "é›†ä¸­ã‚¿ã‚¤ãƒ  (Focus Time)";
        label.style.color = isBreak ? "#f39c12" : "#4a90e2";
    }

    function renderChart() {
        const ctx = document.getElementById('pomoChart').getContext('2d');
        const labels = []; chartDates = []; const datasetsMap = {}; const end = new Date();
        for (let i = currentRange - 1; i >= 0; i--) {
            const d = new Date(); d.setDate(end.getDate() - i);
            const ds = d.toISOString().split('T')[0];
            chartDates.push(ds);
            labels.push(`${d.getMonth()+1}/${d.getDate()}`);
            tagHistory.forEach(tag => {
                if (!datasetsMap[tag]) datasetsMap[tag] = [];
                datasetsMap[tag].push((dailyStats[ds] && dailyStats[ds][tag]) || 0);
            });
        }
        const datasets = Object.keys(datasetsMap).map((tag, idx) => ({
            label: tag, data: datasetsMap[tag], backgroundColor: `hsl(${idx * 137.5}, 70%, 60%)`, borderRadius: 5
        }));

        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar', data: { labels, datasets },
            options: {
                responsive: true, maintainAspectRatio: false,
                scales: { x: { stacked: true }, y: { stacked: true } },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const { datasetIndex, index } = elements[0];
                        selectedTag = myChart.data.datasets[datasetIndex].label;
                        selectedDate = chartDates[index];
                        const btn = document.getElementById('delTargetBtn');
                        btn.style.display = 'block';
                        btn.textContent = `ğŸ—‘ ${selectedDate} ã® ${selectedTag} ã‚’å‰Šé™¤`;
                    }
                }
            }
        });
    }

    // å‰Šé™¤æ©Ÿèƒ½
    function openDeleteModal() {
        const maxTime = dailyStats[selectedDate][selectedTag];
        document.getElementById('delTagTitle').textContent = `ã€Œ${selectedTag}ã€ã‚’å‰Šé™¤`;
        document.getElementById('delDateInfo').textContent = `å¯¾è±¡æ—¥: ${selectedDate}`;
        const slider = document.getElementById('delSlider');
        slider.max = maxTime; slider.value = 25; slider.disabled = false;
        document.getElementById('delValDisplay').textContent = 25;
        document.getElementById('delAllCheck').checked = false;
        slider.oninput = function() { document.getElementById('delValDisplay').textContent = this.value; };
        document.getElementById('deleteModal').style.display = 'flex';
    }

    function toggleDelAll(chk) {
        const slider = document.getElementById('delSlider');
        if (chk.checked) { slider.value = dailyStats[selectedDate][selectedTag]; slider.disabled = true; }
        else { slider.disabled = false; slider.value = 25; }
        document.getElementById('delValDisplay').textContent = slider.value;
    }

    function executeDelete() {
        const amount = parseInt(document.getElementById('delSlider').value);
        if (confirm(`${selectedDate} ã® ${selectedTag} ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            dailyStats[selectedDate][selectedTag] -= amount;
            if (dailyStats[selectedDate][selectedTag] <= 0) delete dailyStats[selectedDate][selectedTag];
            save(); renderChart(); closeDeleteModal();
            document.getElementById('delTargetBtn').style.display = 'none';
        }
    }
    function closeDeleteModal() { document.getElementById('deleteModal').style.display = 'none'; }

    function save() {
        localStorage.setItem('focus_master_stats', JSON.stringify(dailyStats));
        localStorage.setItem('focus_master_tags', JSON.stringify(tagHistory));
    }

    function exportData() {
        const data = JSON.stringify({ stats: dailyStats, tags: tagHistory });
        const blob = new Blob([data], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a'); a.href = url; a.download = `focus_backup.json`; a.click();
    }

    function importData(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            const imported = JSON.parse(e.target.result);
            dailyStats = imported.stats; tagHistory = imported.tags;
            save(); renderChart(); updateTagList(); alert("å¾©å…ƒå®Œäº†ï¼");
        };
        reader.readAsText(file);
    }

    function changeRange(days, btn) { currentRange = days; renderChart(); }
    function updateTagList() {
        const list = document.getElementById('tagHistory');
        list.innerHTML = tagHistory.map(t => `<option value="${t}">`).join('');
    }

    window.onload = () => { updateTimerDisplay(); renderChart(); updateTagList(); };
</script>
</body>
</html>
