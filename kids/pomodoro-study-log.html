<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1V1ELMWFTY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-1V1ELMWFTY');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5115190227060860" crossorigin="anonymous"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›†ä¸­ãƒã‚¹ã‚¿ãƒ¼ Pro / Focus Master Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4a90e2; --accent: #ff00ff; --bg: #111; --card: #ffffff; --pomo: #e74c3c; }
        body { font-family: "Hiragino Sans", sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 10px; box-sizing: border-box; min-height: 100vh; color: #fff; scroll-behavior: smooth; }
        
        .card { background: var(--card); padding: 20px; border-radius: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); text-align: center; width: 100%; max-width: 480px; border: 4px solid #fff; margin-bottom: 15px; box-sizing: border-box; color: #333; }
        
        .pomo-guide { text-align: left; font-size: 0.85rem; line-height: 1.5; color: #333; background: #fdfdfd; border-radius: 20px; padding: 18px; margin-bottom: 15px; border: 2px solid #eee; max-height: 500px; overflow-y: auto; }
        .pomo-guide summary { font-weight: bold; color: var(--primary); cursor: pointer; outline: none; margin-bottom: 8px; font-size: 1rem; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .pomo-guide h4 { border-left: 5px solid var(--accent); padding-left: 10px; margin: 15px 0 5px 0; color: #111; font-size: 0.95rem; }
        .point-box { background: #fff5f5; padding: 12px; border-radius: 12px; margin-top: 10px; font-size: 0.8rem; border-left: 4px solid var(--pomo); }
        .en-small { display: block; color: #666; font-size: 0.75rem; margin-top: 2px; line-height: 1.2; }

        .timer-display { font-size: 4.5rem; font-weight: 900; color: var(--primary); margin: 10px 0; font-variant-numeric: tabular-nums; }
        .tag-input { width: 90%; padding: 12px; border-radius: 12px; border: 2px solid #ddd; font-size: 1rem; text-align: center; margin-bottom: 10px; -webkit-appearance: none; }
        
        .btn-main { width: 100%; padding: 18px; background: var(--accent); color: #fff; border: none; border-radius: 20px; font-weight: 800; font-size: 1.3rem; cursor: pointer; box-shadow: 0 5px 0 #c000c0; }
        .btn-main:active { transform: translateY(3px); box-shadow: 0 2px 0 #c000c0; }
        .btn-tool { background: #95a5a6; color: white; padding: 10px 14px; border-radius: 10px; border: none; font-size: 0.85rem; cursor: pointer; font-weight: bold; }
        
        /* Stats Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .stat-card { background: #f8f9fa; padding: 12px 5px; border-radius: 15px; border: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .stat-card:hover { background: #f0f7ff; transform: scale(1.02); }
        .stat-value { font-size: 1.1rem; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 0.65rem; color: #777; margin-top: 4px; }

        .range-selector { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .custom-range-box { background: #f0f0f0; padding: 12px; border-radius: 15px; margin-bottom: 15px; display: none; flex-wrap: wrap; justify-content: center; gap: 5px; border: 1px solid #ddd; }
        .date-input { padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-size: 0.8rem; }

        .chart-container { background: #fff; padding: 15px; border-radius: 20px; border: 1px solid #eee; margin-top: 10px; height: 260px; }
        .chart-title { font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; color: #555; text-align: left; border-left: 4px solid var(--accent); padding-left: 8px; }

        .footer-area { width: 100%; max-width: 480px; text-align: center; margin-top: 25px; padding-bottom: 30px; }
        .footer-link { display: inline-block; color: #fff; text-decoration: none; font-size: 1.1rem; font-weight: bold; padding: 15px 30px; background: #444; border: 2px solid #666; border-radius: 15px; margin-bottom: 20px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 30px; width: 90%; max-width: 400px; text-align: center; color: #333; overflow-y: auto; max-height: 90vh; }
        .btn-alarm-stop { background: #ff4757; font-size: 1.8rem; padding: 25px; animation: pulse 1s infinite; margin-top: 20px; width: 100%; box-shadow: 0 6px 0 #b33030; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }
    </style>
</head>
<body>

<div class="card">
    <div class="pomo-guide">
        <details open>
            <summary>ğŸ… ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ»ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¨ã¯ï¼Ÿ <br><span style="font-size:0.8rem; font-weight:normal;">What is Pomodoro Technique?</span></summary>
            <p>
                ã€Œ25åˆ†å‹‰å¼·ã€ã¯ã€ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ»ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¨å‘¼ã°ã‚Œã‚‹æ™‚é–“ç®¡ç†è¡“ã§ã€<b>ã€Œ25åˆ†é›†ä¸­ï¼‹5åˆ†ä¼‘æ†©ã€</b>ã‚’ç¹°ã‚Šè¿”ã™ã“ã¨ã§é›†ä¸­åŠ›ã‚’ç¶­æŒã—ã€åŠ¹ç‡çš„ãªå­¦ç¿’ã‚’ä¿ƒã—ã¾ã™ã€‚
            </p>
            <p>
                äººé–“ã®é›†ä¸­åŠ›ã®é™ç•Œã¨è„³ã®ä»•çµ„ã¿ã«åŸºã¥ãã€çŸ­æ™‚é–“ã§ãƒ¡ãƒªãƒãƒªã‚’ã¤ã‘ã¦å‹‰å¼·ã—ãŸã„äººã‚„ã€é›†ä¸­åŠ›ãŒç¶šã‹ãªã„ã¨æ„Ÿã˜ã‚‹ãŠå­æ§˜ã«ã‚‚éå¸¸ã«åŠ¹æœçš„ã§ã™ã€‚
            </p>

            <h4>ğŸ“ ã‚„ã‚Šæ–¹ / Steps</h4>
            <ol>
                <li><b>ã‚¿ã‚¹ã‚¯ã‚’æ±ºã‚ã‚‹:</b> 25åˆ†ã§ã‚„ã‚‹å†…å®¹ï¼ˆä¾‹ï¼šè‹±å˜èª10å€‹ã€æ•°å­¦5å•ï¼‰ã‚’æ˜ç¢ºã«ã—ã¾ã™ã€‚</li>
                <li><b>ã‚¿ã‚¤ãƒãƒ¼ã‚’25åˆ†ã«ã‚»ãƒƒãƒˆ:</b> å‹‰å¼·ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆ1ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ï¼‰ã€‚</li>
                <li><b>5åˆ†ä¼‘æ†©:</b> ã‚¿ã‚¤ãƒãƒ¼ãŒé³´ã£ãŸã‚‰ä¸­æ–­ã—ã€ä¼‘æ†©ã—ã¾ã™ã€‚ã‚¹ãƒãƒ›ã‚’è¦‹ãšã€è„³ã‚’ä¼‘ã‚ã‚‹ã®ãŒã‚³ãƒ„ï¼</li>
                <li><b>ç¹°ã‚Šè¿”ã™:</b> 2ã¨3ã‚’æ•°å›ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚</li>
                <li><b>é•·ã‚ã®ä¼‘æ†©:</b> 4ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ï¼ˆç´„2æ™‚é–“ï¼‰ã”ã¨ã«ã€30åˆ†ã€œ40åˆ†ã®ä¼‘æ†©ã‚’å–ã‚Šã¾ã™ã€‚</li>
            </ol>

            <h4>âœ¨ åŠ¹æœã¨ãƒã‚¤ãƒ³ãƒˆ</h4>
            <ul>
                <li><b>é›†ä¸­åŠ›ã®ç¶­æŒ:</b> çŸ­ã„ã‚µã‚¤ã‚¯ãƒ«ã§ä¼‘æ†©ã‚’æŒŸã‚€ã“ã¨ã§ã€ç–²ã‚Œã‚’æºœã‚ã¾ã›ã‚“ã€‚</li>
                <li><b>ãƒ€ãƒ©ãƒ€ãƒ©é˜²æ­¢:</b> ã€Œ25åˆ†ã ã‘ã€ã¨æ±ºã‚ã‚‹ã“ã¨ã§ã€å–ã‚Šæ›ã‹ã‚Šã‚„ã™ããªã‚Šã¾ã™ã€‚</li>
                <li><b>ç¿’æ…£åŒ–:</b> æ¯æ—¥ç¶šã‘ã‚‹ã“ã¨ã§å­¦ç¿’ã®è¤‡åˆ©åŠ¹æœãŒç”Ÿã¾ã‚Œã€è‡ªä¿¡ã«ç¹‹ãŒã‚Šã¾ã™ã€‚</li>
            </ul>

            <div class="point-box">
                <b>ğŸ’¡ æº–å‚™ãŒå¤§äº‹:</b> å‹‰å¼·é“å…·ã‚’ã™ãä½¿ãˆã‚‹çŠ¶æ…‹ã«ã—ã€ä½•ã‚’ã™ã‚‹ã‹æ˜ç¢ºã«ã—ã¦ãŠãã¨é›†ä¸­ãŒé€”åˆ‡ã‚Œã¾ã›ã‚“ã€‚è‡ªåˆ†ã«åˆã†æ™‚é–“è¨­å®šã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã‚‚å¤§åˆ‡ã§ã™ã€‚
            </div>

            <details style="margin-top: 15px;">
                <summary>âš ï¸ ãƒ‡ãƒ¼ã‚¿ã®æ¶ˆå»ã¨å¾©å…ƒã«ã¤ã„ã¦</summary>
                <div class="point-box">
                    <b>ğŸ’¾ ä¿å­˜ã®ä»•çµ„ã¿:</b> ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã§æ¶ˆãˆã‚‹ãŸã‚ã€å®šæœŸçš„ã«ä¸‹éƒ¨ã®ã€ŒğŸ’¾ ä¿å­˜ã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãã ã•ã„ã€‚
                </div>
            </details>
        </details>
    </div>

    <div style="position: relative; width: 100%;">
        <input type="text" id="studyTag" class="tag-input" list="tagHistory" placeholder="ä¾‹ï¼šè‹±èª / English">
        <datalist id="tagHistory"></datalist>
        <button class="btn-tool" style="background: #34495e; padding: 8px 15px; margin-bottom: 12px; width: 90%;" onclick="openTagManager()">ğŸ· ã‚¿ã‚°å±¥æ­´ãƒ»ç®¡ç†</button>
    </div>
    
    <div id="statusLabel" style="font-weight: bold; color: #666;">é›†ä¸­ã‚¿ã‚¤ãƒ  / Focus Time</div>
    <div class="timer-display" id="timerDisplay">25:00</div>
    <button id="startBtn" class="btn-main" onclick="toggleTimer()">ã‚¹ã‚¿ãƒ¼ãƒˆï¼ / START</button>
</div>

<div class="card" id="analysisCard">
    <div class="dashboard-grid">
        <div class="stat-card" onclick="jumpTo('chartSection')">
            <div class="stat-label">æœŸé–“åˆè¨ˆ</div>
            <div id="totalMinutes" class="stat-value">0</div>
            <div class="stat-label">mins</div>
        </div>
        <div class="stat-card" onclick="jumpTo('pieSection')">
            <div class="stat-label">å®Ÿç¶™ç¶š</div>
            <div id="activeDays" class="stat-value">0</div>
            <div class="stat-label">days</div>
        </div>
        <div class="stat-card" onclick="jumpTo('lineSection')">
            <div class="stat-label">é€£ç¶šç¶™ç¶š</div>
            <div id="streakDays" class="stat-value">0</div>
            <div class="stat-label">days</div>
        </div>
    </div>

    <div class="range-selector">
        <button class="btn-tool" onclick="changeRange(1, this)">ä»Šæ—¥</button>
        <button class="btn-tool" onclick="changeRange(7, this)">1é€±</button>
        <button class="btn-tool" onclick="changeRange(30, this)">1æœˆ</button>
        <button class="btn-tool" style="background: #e67e22;" onclick="toggleCustomRange()">ğŸ“… æœŸé–“æŒ‡å®š</button>
    </div>

    <div id="customRangeBox" class="custom-range-box">
        <input type="date" id="startDate" class="date-input"> ã€œ 
        <input type="date" id="endDate" class="date-input">
        <button class="btn-tool" style="background:var(--primary); padding: 5px 10px;" onclick="applyCustomRange()">é©ç”¨</button>
    </div>
    
    <div class="chart-container" id="chartSection">
        <div class="chart-title">å­¦ç¿’æ¨ç§» / Daily Log</div>
        <canvas id="pomoChart"></canvas>
    </div>

    <div class="chart-container" id="pieSection" style="height: 300px;">
        <div class="chart-title">æ™‚é–“é…åˆ† / Distribution</div>
        <canvas id="pieChart"></canvas>
    </div>

    <div class="chart-container" id="lineSection">
        <div class="chart-title">ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¨ç§» / Trends</div>
        <canvas id="lineChart"></canvas>
    </div>
    
    <button class="btn-tool" id="delTargetBtn" onclick="openDeleteModal()" style="display:none; width:100%; margin-top:15px; padding: 15px; background:#ff4757;">ğŸ—‘ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ / Delete Data</button>
    
    <div style="display:flex; gap:8px; justify-content:center; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
        <button class="btn-tool" style="background:#27ae60;" onclick="exportData()">ğŸ’¾ ä¿å­˜</button>
        <button class="btn-tool" style="background:#2980b9;" onclick="document.getElementById('importFile').click()">ğŸ“‚ å¾©å…ƒ</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
</div>

<div class="footer-area">
    <a href="./menu.html" class="footer-link">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ / Back to Menu</a>
    <div class="copyright" style="color:#888; font-size:0.8rem;">Â© 2026 KuniFami Soft Studio.</div>
</div>

<div id="tagManagerModal" class="modal"><div class="modal-content"><h3 style="margin-top:0;">ã‚¿ã‚°ã®ç®¡ç†</h3><button class="btn-tool" style="width:100%; background:var(--primary); margin-bottom:15px;" onclick="addNewTag()">ï¼‹ æ–°è¦ã‚¿ã‚°è¿½åŠ </button><div id="tagListContainer" style="text-align:left; border-top:1px solid #eee;"></div><button class="btn-tool" style="width:100%; background:#ccc; margin-top:15px;" onclick="closeTagManager()">é–‰ã˜ã‚‹</button></div></div>
<div id="alarmModal" class="modal"><div class="modal-content"><h2 id="alarmTitle" style="color:var(--primary); font-size:2.2rem; margin:0;">æ™‚é–“ã§ã™ï¼</h2><button class="btn-main btn-alarm-stop" onclick="stopAlarm()">æ­¢ã‚ã‚‹ / OK</button></div></div>
<div id="deleteModal" class="modal"><div class="modal-content"><h3 id="delTagTitle" style="color:var(--pomo); margin-top:0;">ã‚¿ã‚°å‰Šé™¤</h3><p id="delDateInfo"></p><input type="range" id="delSlider" style="width:100%" step="25" min="25"><div style="margin:15px 0;"><label><input type="checkbox" id="delAllCheck" onchange="toggleDelAll(this)"> å…¨ã¦å‰Šé™¤</label></div><div style="display:flex; gap:10px;"><button class="btn-tool" style="flex:1; background:#ccc;" onclick="closeDeleteModal()">æˆ»ã‚‹</button><button class="btn-tool" style="background:#ff4757; flex:1;" onclick="executeDelete()">å®Ÿè¡Œ</button></div></div></div>

<script>
    const STUDY_TIME = 25 * 60;
    const BREAK_TIME = 5 * 60;
    let timeLeft = STUDY_TIME;
    let timerIdx = null;
    let isBreak = false;
    let dailyStats = JSON.parse(localStorage.getItem('focus_master_stats')) || {};
    let tagHistory = JSON.parse(localStorage.getItem('focus_master_tags')) || [];
    let currentRange = 7;
    let myChart = null, pieChart = null, lineChart = null;
    let audioCtx = null;
    let selectedTag = null, selectedDate = null;

    function jumpTo(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }
    function toggleCustomRange() { const box = document.getElementById('customRangeBox'); box.style.display = (box.style.display === 'flex') ? 'none' : 'flex'; }

    function applyCustomRange() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        if (!start || !end) return alert("æœŸé–“ã‚’æ­£ã—ãé¸æŠã—ã¦ãã ã•ã„");
        currentRange = 'custom';
        renderAllCharts(start, end);
    }

    function renderAllCharts(cStart = null, cEnd = null) {
        const labels = []; const chartDates = [];
        const datasetsMap = {}; const categoryTotals = {};
        let rangeTotal = 0, actualActiveDays = 0;

        if (cStart && cEnd) {
            let curr = new Date(cStart); const stop = new Date(cEnd);
            while (curr <= stop) {
                const ds = curr.toISOString().split('T')[0];
                chartDates.push(ds); labels.push(`${curr.getMonth()+1}/${curr.getDate()}`);
                
                let dayHasData = false;
                tagHistory.forEach(tag => {
                    if (!datasetsMap[tag]) datasetsMap[tag] = [];
                    const val = (dailyStats[ds] && dailyStats[ds][tag]) || 0;
                    datasetsMap[tag].push(val);
                    rangeTotal += val;
                    categoryTotals[tag] = (categoryTotals[tag] || 0) + val;
                    if(val > 0) dayHasData = true;
                });
                if(dayHasData) actualActiveDays++;
                curr.setDate(curr.getDate() + 1);
            }
        } else {
            const end = new Date();
            for (let i = currentRange - 1; i >= 0; i--) {
                const d = new Date(); d.setDate(end.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                chartDates.push(ds); labels.push(`${d.getMonth()+1}/${d.getDate()}`);
                
                let dayHasData = false;
                tagHistory.forEach(tag => {
                    if (!datasetsMap[tag]) datasetsMap[tag] = [];
                    const val = (dailyStats[ds] && dailyStats[ds][tag]) || 0;
                    datasetsMap[tag].push(val);
                    rangeTotal += val;
                    categoryTotals[tag] = (categoryTotals[tag] || 0) + val;
                    if(val > 0) dayHasData = true;
                });
                if(dayHasData) actualActiveDays++;
            }
        }

        updateDashboard(rangeTotal, actualActiveDays);
        drawBarChart(labels, chartDates, datasetsMap);
        drawPieChart(categoryTotals);
        drawLineChart(labels, datasetsMap);
    }

    function updateDashboard(total, activeDays) {
        document.getElementById('totalMinutes').innerText = total;
        document.getElementById('activeDays').innerText = activeDays;
        document.getElementById('streakDays').innerText = calculateStreak();
    }

    function drawBarChart(labels, chartDates, datasetsMap) {
        const ctx = document.getElementById('pomoChart').getContext('2d');
        const datasets = Object.keys(datasetsMap).map((tag, idx) => ({
            label: tag, data: datasetsMap[tag], backgroundColor: `hsl(${idx * 137.5}, 70%, 60%)`, borderRadius: 4
        }));
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar', data: { labels, datasets },
            options: { 
                responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const { datasetIndex, index } = elements[0];
                        selectedTag = myChart.data.datasets[datasetIndex].label;
                        selectedDate = chartDates[index];
                        const btn = document.getElementById('delTargetBtn');
                        btn.style.display = 'block'; btn.textContent = `ğŸ—‘ ${selectedDate} [${selectedTag}] å‰Šé™¤`;
                    }
                }
            }
        });
    }

    function drawPieChart(catTotals) {
        const ctx = document.getElementById('pieChart').getContext('2d');
        const tags = Object.keys(catTotals).filter(t => catTotals[t] > 0);
        if (pieChart) pieChart.destroy();
        const chartData = tags.map(t => catTotals[t]);
        const chartColors = tags.map((tag) => {
            const idx = tagHistory.indexOf(tag);
            return `hsl(${idx * 137.5}, 70%, 60%)`;
        });
        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: tags, datasets: [{ data: chartData, backgroundColor: chartColors }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
        });
    }

    function drawLineChart(labels, datasetsMap) {
        const ctx = document.getElementById('lineChart').getContext('2d');
        const datasets = Object.keys(datasetsMap).map((tag, idx) => ({
            label: tag, data: datasetsMap[tag], borderColor: `hsl(${idx * 137.5}, 70%, 60%)`, tension: 0.3, pointRadius: 2
        }));
        if (lineChart) lineChart.destroy();
        lineChart = new Chart(ctx, {
            type: 'line', data: { labels, datasets },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function toggleTimer() {
        initAudio(); const btn = document.getElementById('startBtn');
        if (timerIdx) { clearInterval(timerIdx); timerIdx = null; btn.textContent = "å†é–‹ / Resume"; }
        else {
            btn.textContent = "ä¸€æ™‚åœæ­¢ / Pause";
            timerIdx = setInterval(() => {
                timeLeft--; updateTimerDisplay();
                if (timeLeft <= 0) { clearInterval(timerIdx); timerIdx = null; startAlarm(); }
            }, 1000);
        }
    }
    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60); const s = timeLeft % 60;
        document.getElementById('timerDisplay').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function startAlarm() { document.getElementById('alarmTitle').textContent = isBreak ? "ä¼‘æ†©çµ‚äº†ï¼" : "é›†ä¸­çµ‚äº†ï¼"; document.getElementById('alarmModal').style.display='flex'; }
    function stopAlarm() { document.getElementById('alarmModal').style.display='none'; handleTimerEnd(); }
    function handleTimerEnd() {
        const tag = document.getElementById('studyTag').value.trim() || "ãã®ä»–";
        const today = new Date().toISOString().split('T')[0];
        if (!isBreak) {
            if (!dailyStats[today]) dailyStats[today] = {};
            dailyStats[today][tag] = (dailyStats[today][tag] || 0) + 25;
            if (!tagHistory.includes(tag)) tagHistory.push(tag);
            save(); isBreak = true; timeLeft = BREAK_TIME;
        } else { isBreak = false; timeLeft = STUDY_TIME; }
        renderAllCharts(); updateTagList(); updateTimerDisplay();
        document.getElementById('startBtn').textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆï¼ / START";
    }

    function save() { localStorage.setItem('focus_master_stats', JSON.stringify(dailyStats)); localStorage.setItem('focus_master_tags', JSON.stringify(tagHistory)); }
    function exportData() { const blob = new Blob([JSON.stringify({stats: dailyStats, tags: tagHistory})], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'focus_backup.json'; a.click(); }
    function importData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { const data = JSON.parse(ev.target.result); dailyStats = data.stats; tagHistory = data.tags; save(); renderAllCharts(); updateTagList(); alert("å¾©å…ƒå®Œäº†"); };
        reader.readAsText(e.target.files[0]);
    }
    function changeRange(d, btn) { currentRange = d; document.getElementById('customRangeBox').style.display='none'; renderAllCharts(); }

    function calculateStreak() {
        // å…¨ã¦ã®æ—¥ä»˜ã‚’å–å¾—ã—ã¦é™é †ã«ä¸¦ã¹æ›¿ãˆ
        const dates = Object.keys(dailyStats).filter(d => {
            const dayData = dailyStats[d];
            return dayData && Object.values(dayData).some(v => v > 0);
        }).sort().reverse();
        
        if (dates.length === 0) return 0;

        // ä»Šæ—¥ã®æ—¥ä»˜æ–‡å­—åˆ—
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        
        // æ˜¨æ—¥ã®æ—¥ä»˜æ–‡å­—åˆ—
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];

        // æœ€æ–°ã®è¨˜éŒ²æ—¥ãŒã€Œä»Šæ—¥ã€ã§ã‚‚ã€Œæ˜¨æ—¥ã€ã§ã‚‚ãªã‘ã‚Œã°ã€é€£ç¶šã¯é€”çµ¶ãˆã¦ã„ã‚‹
        if (dates[0] !== todayStr && dates[0] !== yesterdayStr) return 0;

        let streak = 0;
        let checkDate = new Date(dates[0]); // æœ€æ–°ã®è¨˜éŒ²æ—¥ã‹ã‚‰é¡ã‚‹

        while (true) {
            const ds = checkDate.toISOString().split('T')[0];
            const hasData = dailyStats[ds] && Object.values(dailyStats[ds]).some(val => val > 0);
            
            if (hasData) {
                streak++;
                checkDate.setDate(checkDate.getDate() - 1); // 1æ—¥æˆ»ã‚‹
            } else {
                break;
            }
        }
        return streak;
    }

    function updateTagList() { document.getElementById('tagHistory').innerHTML = tagHistory.map(t => `<option value="${t}">`).join(''); }
    function openTagManager() {
        const container = document.getElementById('tagListContainer');
        container.innerHTML = tagHistory.map(t => `
            <div style="padding:12px; border-bottom:1px solid #eee; display:flex; flex-direction:column; gap:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:bold; color:var(--primary); cursor:pointer;" onclick="document.getElementById('studyTag').value='${t}'; closeTagManager()">${t}</span>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-tool" style="background:#f39c12; padding:5px 10px;" onclick="renameTag('${t}')">ç·¨é›†</button>
                        <button class="btn-tool" style="background:#ff4757; padding:5px 10px;" onclick="deleteTagHistory('${t}')">å‰Šé™¤</button>
                    </div>
                </div>
            </div>`).join('');
        document.getElementById('tagManagerModal').style.display='flex';
    }
    function closeTagManager() { document.getElementById('tagManagerModal').style.display='none'; }
    function addNewTag() { const t = prompt("æ–°è¦ã‚¿ã‚°å:"); if(t && !tagHistory.includes(t.trim())){ tagHistory.push(t.trim()); save(); updateTagList(); openTagManager(); } }
    
    function renameTag(oldTag) {
        const newTag = prompt(`ã€Œ${oldTag}ã€ã®æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„:`, oldTag);
        if (!newTag || newTag.trim() === "" || newTag.trim() === oldTag) return;
        const trimmedNewTag = newTag.trim();
        if (tagHistory.includes(trimmedNewTag)) {
            if (!confirm(`ã€Œ${trimmedNewTag}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã¾ã™ã‹ï¼Ÿ`)) return;
        }
        for (let date in dailyStats) {
            if (dailyStats[date][oldTag] !== undefined) {
                const value = dailyStats[date][oldTag];
                dailyStats[date][trimmedNewTag] = (dailyStats[date][trimmedNewTag] || 0) + value;
                delete dailyStats[date][oldTag];
            }
        }
        tagHistory = tagHistory.filter(t => t !== oldTag);
        if (!tagHistory.includes(trimmedNewTag)) tagHistory.push(trimmedNewTag);
        save(); renderAllCharts(); updateTagList(); openTagManager();
    }

    function deleteTagHistory(t) { if(confirm(`${t} ã®çµ±è¨ˆã‚‚å«ã‚ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)){ tagHistory = tagHistory.filter(x => x!==t); for(let d in dailyStats) delete dailyStats[d][t]; save(); renderAllCharts(); openTagManager(); } }
    function openDeleteModal() { const max = dailyStats[selectedDate][selectedTag]; document.getElementById('delDateInfo').textContent = `${selectedDate} [${selectedTag}]`; const slider = document.getElementById('delSlider'); slider.max = max; slider.value = 25; document.getElementById('deleteModal').style.display = 'flex'; }
    function closeDeleteModal() { document.getElementById('deleteModal').style.display = 'none'; }
    function executeDelete() { const val = parseInt(document.getElementById('delSlider').value); dailyStats[selectedDate][selectedTag] -= val; if(dailyStats[selectedDate][selectedTag] <= 0) delete dailyStats[selectedDate][selectedTag]; save(); renderAllCharts(); closeDeleteModal(); document.getElementById('delTargetBtn').style.display = 'none'; }
    function toggleDelAll(chk) { if(chk.checked) document.getElementById('delSlider').value = document.getElementById('delSlider').max; }

    window.onload = () => { 
        updateTagList(); 
        document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
        renderAllCharts(); 
    };
</script>
</body>
</html>
