<!DOCTYPE html>
<html lang="ja">
<head>
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-1V1ELMWFTY"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-1V1ELMWFTY');
    </script>
    <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-5115190227060860" crossorigin="anonymous"></script>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é›†ä¸­ãƒã‚¹ã‚¿ãƒ¼ Pro / Focus Master Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --primary: #4a90e2; --accent: #ff00ff; --bg: #111; --card: #ffffff; --pomo: #e74c3c; }
        body { font-family: "Hiragino Sans", sans-serif; background: var(--bg); display: flex; flex-direction: column; align-items: center; padding: 10px; box-sizing: border-box; min-height: 100vh; color: #fff; scroll-behavior: smooth; }
        
        .card { background: var(--card); padding: 20px; border-radius: 30px; box-shadow: 0 8px 20px rgba(0,0,0,0.5); text-align: center; width: 100%; max-width: 480px; border: 4px solid #fff; margin-bottom: 15px; box-sizing: border-box; color: #333; }
        
        .pomo-guide { text-align: left; font-size: 0.85rem; line-height: 1.5; color: #333; background: #fdfdfd; border-radius: 20px; padding: 18px; margin-bottom: 15px; border: 2px solid #eee; max-height: 500px; overflow-y: auto; }
        .pomo-guide summary { font-weight: bold; color: var(--primary); cursor: pointer; outline: none; margin-bottom: 8px; font-size: 1rem; border-bottom: 2px solid #eee; padding-bottom: 5px; }
        .pomo-guide h4 { border-left: 5px solid var(--accent); padding-left: 10px; margin: 15px 0 5px 0; color: #111; font-size: 0.95rem; }
        .point-box { background: #fff5f5; padding: 12px; border-radius: 12px; margin-top: 10px; font-size: 0.8rem; border-left: 4px solid var(--pomo); }
        .en-small { display: block; color: #666; font-size: 0.75rem; margin-top: 2px; line-height: 1.2; }

        .timer-display { font-size: 4.5rem; font-weight: 900; color: var(--primary); margin: 10px 0; font-variant-numeric: tabular-nums; }
        .tag-input { width: 90%; padding: 12px; border-radius: 12px; border: 2px solid #ddd; font-size: 1rem; text-align: center; margin-bottom: 10px; -webkit-appearance: none; }
        
        .btn-main { width: 100%; padding: 18px; background: var(--accent); color: #fff; border: none; border-radius: 20px; font-weight: 800; font-size: 1.3rem; cursor: pointer; box-shadow: 0 5px 0 #c000c0; }
        .btn-main:active { transform: translateY(3px); box-shadow: 0 2px 0 #c000c0; }
        .btn-tool { background: #95a5a6; color: white; padding: 10px 14px; border-radius: 10px; border: none; font-size: 0.85rem; cursor: pointer; font-weight: bold; }
        
        /* Stats Dashboard */
        .dashboard-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 15px; }
        .stat-card { background: #f8f9fa; padding: 12px 5px; border-radius: 15px; border: 1px solid #eee; cursor: pointer; transition: 0.2s; }
        .stat-card:hover { background: #f0f7ff; transform: scale(1.02); }
        .stat-value { font-size: 1.1rem; font-weight: bold; color: var(--primary); }
        .stat-label { font-size: 0.65rem; color: #777; margin-top: 4px; }

        .range-selector { display: flex; justify-content: center; gap: 5px; margin-bottom: 10px; flex-wrap: wrap; }
        .custom-range-box { background: #f0f0f0; padding: 12px; border-radius: 15px; margin-bottom: 15px; display: none; flex-wrap: wrap; justify-content: center; gap: 5px; border: 1px solid #ddd; }
        .date-input { padding: 5px; border-radius: 5px; border: 1px solid #ccc; font-size: 0.8rem; }

        .chart-container { background: #fff; padding: 15px; border-radius: 20px; border: 1px solid #eee; margin-top: 10px; height: 260px; }
        .chart-title { font-size: 0.85rem; font-weight: bold; margin-bottom: 8px; color: #555; text-align: left; border-left: 4px solid var(--accent); padding-left: 8px; }

        .footer-area { width: 100%; max-width: 480px; text-align: center; margin-top: 25px; padding-bottom: 30px; }
        .footer-link { display: inline-block; color: #fff; text-decoration: none; font-size: 1.1rem; font-weight: bold; padding: 15px 30px; background: #444; border: 2px solid #666; border-radius: 15px; margin-bottom: 20px; }

        .modal { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 2000; align-items: center; justify-content: center; }
        .modal-content { background: white; padding: 25px; border-radius: 30px; width: 90%; max-width: 400px; text-align: center; color: #333; overflow-y: auto; max-height: 90vh; }
        .btn-alarm-stop { background: #ff4757; font-size: 1.8rem; padding: 25px; animation: pulse 1s infinite; margin-top: 20px; width: 100%; box-shadow: 0 6px 0 #b33030; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.03); } 100% { transform: scale(1); } }

        /* User Switcher Styles */
        .user-switcher { display: flex; align-items: center; justify-content: space-between; background: #f0f7ff; padding: 10px 15px; border-radius: 15px; margin-bottom: 15px; border: 1px solid #d0e5ff; }
        .current-user-info { text-align: left; }
        .current-user-name { font-weight: bold; color: var(--primary); font-size: 1rem; display: block; }
    </style>
</head>
<body>

<div class="card">
    <div class="user-switcher">
        <div class="current-user-info">
            <span style="font-size: 0.7rem; color: #777;">ç¾åœ¨ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ / User</span>
            <span id="activeUserName" class="current-user-name">ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ</span>
        </div>
        <div style="display: flex; gap: 5px;">
            <button class="btn-tool" style="background: #34495e; padding: 5px 10px;" onclick="openUserModal()">åˆ‡æ›¿ / Switch</button>
            <button class="btn-tool" style="background: #95a5a6; padding: 5px 10px;" onclick="renameCurrentUser()">ç·¨é›† / Edit</button>
        </div>
    </div>

    <div class="pomo-guide">
        <details open>
            <summary>ğŸ… ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ»ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¨ã¯ï¼Ÿ <br><span style="font-size:0.8rem; font-weight:normal;">What is Pomodoro Technique?</span></summary>
            <p>
                ã€Œ25åˆ†å‹‰å¼·ã€ã¯ã€ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ãƒ»ãƒ†ã‚¯ãƒ‹ãƒƒã‚¯ã¨å‘¼ã°ã‚Œã‚‹æ™‚é–“ç®¡ç†è¡“ã§ã€<b>ã€Œ25åˆ†é›†ä¸­ï¼‹5åˆ†ä¼‘æ†©ã€</b>ã‚’ç¹°ã‚Šè¿”ã™ã“ã¨ã§é›†ä¸­åŠ›ã‚’ç¶­æŒã—ã€åŠ¹ç‡çš„ãªå­¦ç¿’ã‚’ä¿ƒã—ã¾ã™ã€‚
                <span class="en-small">"25-min study" is a time management method called the Pomodoro Technique. By repeating "25 mins of focus + 5 mins of break," you can maintain concentration and boost learning efficiency.</span>
            </p>
            <p>
                äººé–“ã®é›†ä¸­åŠ›ã®é™ç•Œã¨è„³ã®ä»•çµ„ã¿ã«åŸºã¥ãã€çŸ­æ™‚é–“ã§ãƒ¡ãƒªãƒãƒªã‚’ã¤ã‘ã¦å‹‰å¼·ã—ãŸã„äººã‚„ã€é›†ä¸­åŠ›ãŒç¶šã‹ãªã„ã¨æ„Ÿã˜ã‚‹ãŠå­æ§˜ã«ã‚‚éå¸¸ã«åŠ¹æœçš„ã§ã™ã€‚
                <span class="en-small">Based on the human attention span and brain mechanics, it's highly effective for those who want to study with focus in short bursts, or for children who struggle to stay concentrated.</span>
            </p>

            <h4>ğŸ“ ã‚„ã‚Šæ–¹ / Steps</h4>
            <ol>
                <li><b>ã‚¿ã‚¹ã‚¯ã‚’æ±ºã‚ã‚‹ / Choose a task:</b> 25åˆ†ã§ã‚„ã‚‹å†…å®¹ï¼ˆä¾‹ï¼šè‹±å˜èª10å€‹ã€æ•°å­¦5å•ï¼‰ã‚’æ˜ç¢ºã«ã—ã¾ã™ã€‚
                <span class="en-small">Decide what to do in 25 mins (e.g., 10 vocab words, 5 math problems).</span></li>
                <li><b>ã‚¿ã‚¤ãƒãƒ¼ã‚’25åˆ†ã«ã‚»ãƒƒãƒˆ / Set timer for 25 mins:</b> å‹‰å¼·ã‚’é–‹å§‹ã—ã¾ã™ï¼ˆ1ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ï¼‰ã€‚
                <span class="en-small">Start studying (1 Pomodoro).</span></li>
                <li><b>5åˆ†ä¼‘æ†© / 5-minute break:</b> ã‚¿ã‚¤ãƒãƒ¼ãŒé³´ã£ãŸã‚‰ä¸­æ–­ã—ã€ä¼‘æ†©ã—ã¾ã™ã€‚ã‚¹ãƒãƒ›ã‚’è¦‹ãšã€è„³ã‚’ä¼‘ã‚ã‚‹ã®ãŒã‚³ãƒ„ï¼
                <span class="en-small">When the timer rings, stop and rest. Avoid screens to give your brain a real break!</span></li>
                <li><b>ç¹°ã‚Šè¿”ã™ / Repeat:</b> 2ã¨3ã‚’æ•°å›ç¹°ã‚Šè¿”ã—ã¾ã™ã€‚
                <span class="en-small">Repeat steps 2 and 3 several times.</span></li>
                <li><b>é•·ã‚ã®ä¼‘æ†© / Long break:</b> 4ãƒãƒ¢ãƒ‰ãƒ¼ãƒ­ï¼ˆç´„2æ™‚é–“ï¼‰ã”ã¨ã«ã€30åˆ†ã€œ40åˆ†ã®ä¼‘æ†©ã‚’å–ã‚Šã¾ã™ã€‚
                <span class="en-small">Take a 30-40 min break every 4 Pomodoros (approx. 2 hours).</span></li>
            </ol>

            <h4>âœ¨ åŠ¹æœã¨ãƒã‚¤ãƒ³ãƒˆ / Benefits & Tips</h4>
            <ul>
                <li><b>é›†ä¸­åŠ›ã®ç¶­æŒ / Maintain Focus:</b> çŸ­ã„ã‚µã‚¤ã‚¯ãƒ«ã§ä¼‘æ†©ã‚’æŒŸã‚€ã“ã¨ã§ã€ç–²ã‚Œã‚’æºœã‚ã¾ã›ã‚“ã€‚
                <span class="en-small">Regular breaks prevent fatigue.</span></li>
                <li><b>ãƒ€ãƒ©ãƒ€ãƒ©é˜²æ­¢ / Stop Procrastinating:</b> ã€Œ25åˆ†ã ã‘ã€ã¨æ±ºã‚ã‚‹ã“ã¨ã§ã€å–ã‚Šæ›ã‹ã‚Šã‚„ã™ããªã‚Šã¾ã™ã€‚
                <span class="en-small">Knowing it's "only 25 mins" makes it easier to start.</span></li>
                <li><b>ç¿’æ…£åŒ– / Build Habits:</b> æ¯æ—¥ç¶šã‘ã‚‹ã“ã¨ã§å­¦ç¿’ã®è¤‡åˆ©åŠ¹æœãŒç”Ÿã¾ã‚Œã€è‡ªä¿¡ã«ç¹‹ãŒã‚Šã¾ã™ã€‚
                <span class="en-small">Daily practice creates a compound effect and builds confidence.</span></li>
            </ul>

            <div class="point-box">
                <b>ğŸ’¡ æº–å‚™ãŒå¤§äº‹ / Prep is Key:</b> å‹‰å¼·é“å…·ã‚’ã™ãä½¿ãˆã‚‹çŠ¶æ…‹ã«ã—ã€ä½•ã‚’ã™ã‚‹ã‹æ˜ç¢ºã«ã—ã¦ãŠãã¨é›†ä¸­ãŒé€”åˆ‡ã‚Œã¾ã›ã‚“ã€‚è‡ªåˆ†ã«åˆã†æ™‚é–“è¨­å®šã‚’è¦‹ã¤ã‘ã‚‹ã“ã¨ã‚‚å¤§åˆ‡ã§ã™ã€‚
                <span class="en-small">Have your tools ready and goals clear to stay in the zone. It's also important to find the time settings that work best for you.</span>
            </div>

            <details style="margin-top: 15px;">
                <summary>âš ï¸ ãƒ‡ãƒ¼ã‚¿ã®æ¶ˆå»ã¨å¾©å…ƒã«ã¤ã„ã¦ <br><span style="font-size:0.75rem;">Data Reset & Restore</span></summary>
                <div class="point-box">
                    <b>ğŸ’¾ ä¿å­˜ã®ä»•çµ„ã¿ / Storage:</b> <br>
                    ãƒ–ãƒ©ã‚¦ã‚¶ï¼ˆlocalStorageï¼‰ã«ä¿å­˜ã•ã‚Œã¾ã™ã€‚ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤ã§æ¶ˆãˆã‚‹ãŸã‚ã€å®šæœŸçš„ã«ä¸‹éƒ¨ã®ã€ŒğŸ’¾ ä¿å­˜ã€ã§ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’å–ã£ã¦ãã ã•ã„ã€‚<br>
                    <span style="font-size:0.75rem; color:#666;">Data is saved in your browser. Since clearing cache will delete it, please use "ğŸ’¾ Save" below regularly for backups.</span>
                </div>
            </details>

            <details style="margin-top: 10px;">
                <summary>ğŸ“± ç”»é¢ãŒæ¶ˆãˆã¦ã—ã¾ã†å ´åˆ <br><span style="font-size:0.75rem;">Keep Screen On</span></summary>
                <div class="point-box" style="background: #f0f7ff; border-left-color: var(--primary);">
                    ã‚¿ã‚¤ãƒãƒ¼å‹•ä½œä¸­ã¯ç”»é¢ãŒæ¶ˆãˆãªã„è¨­å®šã‚’è©¦ã¿ã¾ã™ãŒã€ç«¯æœ«è‡ªä½“ã®è¨­å®šãŒå„ªå…ˆã•ã‚Œã‚‹å ´åˆãŒã‚ã‚Šã¾ã™ã€‚
                    è‡ªå‹•ãƒ­ãƒƒã‚¯ã‚’ä¸€æ™‚çš„ã«ã€Œãªã—ã€ã«è¨­å®šã™ã‚‹ã“ã¨ã‚’ãŠã™ã™ã‚ã—ã¾ã™ã€‚<br><br>
                    <b>â€¢ iPhone:</b> ã€Œè¨­å®šã€>ã€Œç”»é¢è¡¨ç¤ºã¨æ˜ã‚‹ã•ã€>ã€Œè‡ªå‹•ãƒ­ãƒƒã‚¯ã€ã‚’ã€Œãªã—ã€ã«ã™ã‚‹ã€‚<br>
                    <b>â€¢ Android:</b> ã€Œè¨­å®šã€>ã€Œãƒ‡ã‚£ã‚¹ãƒ—ãƒ¬ã‚¤ã€>ã€Œç”»é¢ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆã€ã‚’é•·ãã™ã‚‹ã€‚
                </div>
            </details>
        </details>
    </div>

    <div style="position: relative; width: 100%;">
        <input type="text" id="studyTag" class="tag-input" list="tagHistory" placeholder="ä¾‹ï¼šè‹±èª / English">
        <datalist id="tagHistory"></datalist>
        <button class="btn-tool" style="background: #34495e; padding: 8px 15px; margin-bottom: 12px; width: 90%;" onclick="openTagManager()">ğŸ· ã‚¿ã‚°å±¥æ­´ãƒ»ç®¡ç† / Tag History</button>
    </div>
    
    <div id="statusLabel" style="font-weight: bold; color: #666;">é›†ä¸­ã‚¿ã‚¤ãƒ  / Focus Time</div>
    <div class="timer-display" id="timerDisplay">25:00</div>
    <button id="startBtn" class="btn-main" onclick="toggleTimer()">ã‚¹ã‚¿ãƒ¼ãƒˆï¼ / START</button>
</div>

<div class="card" id="analysisCard">
    <div class="dashboard-grid">
        <div class="stat-card" onclick="jumpTo('chartSection')">
            <div class="stat-label">æœŸé–“åˆè¨ˆ<br>Total</div>
            <div id="totalMinutes" class="stat-value">0</div>
            <div class="stat-label">mins</div>
        </div>
        <div class="stat-card" onclick="jumpTo('pieSection')">
            <div class="stat-label">å®Ÿç¶™ç¶š<br>Active</div>
            <div id="activeDays" class="stat-value">0</div>
            <div class="stat-label">days</div>
        </div>
        <div class="stat-card" onclick="jumpTo('lineSection')">
            <div class="stat-label">é€£ç¶šç¶™ç¶š<br>Streak</div>
            <div id="streakDays" class="stat-value">0</div>
            <div class="stat-label">days</div>
        </div>
    </div>

    <div class="range-selector">
        <button class="btn-tool" onclick="changeRange(1, this)">ä»Šæ—¥ / Today</button>
        <button class="btn-tool" onclick="changeRange(7, this)">1é€± / 1W</button>
        <button class="btn-tool" onclick="changeRange(30, this)">1æœˆ / 1M</button>
        <button class="btn-tool" style="background: #e67e22;" onclick="toggleCustomRange()">ğŸ“… æœŸé–“æŒ‡å®š / Range</button>
    </div>

    <div id="customRangeBox" class="custom-range-box">
        <input type="date" id="startDate" class="date-input"> ã€œ 
        <input type="date" id="endDate" class="date-input">
        <button class="btn-tool" style="background:var(--primary); padding: 5px 10px;" onclick="applyCustomRange()">é©ç”¨ / Apply</button>
    </div>
    
    <div class="chart-container" id="chartSection">
        <div class="chart-title">å­¦ç¿’æ¨ç§» / Daily Log</div>
        <canvas id="pomoChart"></canvas>
    </div>

    <div class="chart-container" id="pieSection" style="height: 300px;">
        <div class="chart-title">æ™‚é–“é…åˆ† / Distribution</div>
        <canvas id="pieChart"></canvas>
    </div>

    <div class="chart-container" id="lineSection">
        <div class="chart-title">ã‚«ãƒ†ã‚´ãƒªåˆ¥æ¨ç§» / Trends</div>
        <canvas id="lineChart"></canvas>
    </div>
    
    <button class="btn-tool" id="delTargetBtn" onclick="openDeleteModal()" style="display:none; width:100%; margin-top:15px; padding: 15px; background:#ff4757;">ğŸ—‘ ãƒ‡ãƒ¼ã‚¿å‰Šé™¤ / Delete Data</button>
    
    <div style="display:flex; gap:8px; justify-content:center; margin-top:15px; border-top:1px solid #eee; padding-top:15px;">
        <button class="btn-tool" style="background:#27ae60;" onclick="exportData()">ğŸ’¾ ä¿å­˜ / Save</button>
        <button class="btn-tool" style="background:#2980b9;" onclick="document.getElementById('importFile').click()">ğŸ“‚ å¾©å…ƒ / Restore</button>
        <input type="file" id="importFile" style="display:none" onchange="importData(event)">
    </div>
</div>

<div class="footer-area">
    <a href="./menu.html" class="footer-link">â† ãƒ¡ãƒ‹ãƒ¥ãƒ¼ã¸ / Back to Menu</a>
    <div class="copyright" style="color:#888; font-size:0.8rem;">Â© 2026 KuniFami Soft Studio.</div>
</div>

<div id="userModal" class="modal"><div class="modal-content"><h3 style="margin-top:0;">ãƒ¦ãƒ¼ã‚¶ãƒ¼åˆ‡æ›¿ / Switch User</h3><button class="btn-tool" style="width:100%; background:var(--primary); margin-bottom:15px;" onclick="addNewUser()">ï¼‹ æ–°è¦ãƒ¦ãƒ¼ã‚¶ãƒ¼è¿½åŠ  / New User</button><div id="userListContainer" style="text-align:left; border-top:1px solid #eee; max-height: 300px; overflow-y: auto;"></div><button class="btn-tool" style="width:100%; background:#ccc; margin-top:15px;" onclick="closeUserModal()">é–‰ã˜ã‚‹ / Close</button></div></div>

<div id="tagManagerModal" class="modal"><div class="modal-content"><h3 style="margin-top:0;">ã‚¿ã‚°ã®ç®¡ç† / Tag Manager</h3><button class="btn-tool" style="width:100%; background:var(--primary); margin-bottom:15px;" onclick="addNewTag()">ï¼‹ æ–°è¦ã‚¿ã‚°è¿½åŠ  / New Tag</button><div id="tagListContainer" style="text-align:left; border-top:1px solid #eee;"></div><button class="btn-tool" style="width:100%; background:#ccc; margin-top:15px;" onclick="closeTagManager()">é–‰ã˜ã‚‹ / Close</button></div></div>
<div id="alarmModal" class="modal"><div class="modal-content"><h2 id="alarmTitle" style="color:var(--primary); font-size:2.2rem; margin:0;">æ™‚é–“ã§ã™ï¼</h2><button class="btn-main btn-alarm-stop" onclick="stopAlarm()">æ­¢ã‚ã‚‹ / OK</button></div></div>
<div id="deleteModal" class="modal"><div class="modal-content"><h3 id="delTagTitle" style="color:var(--pomo); margin-top:0;">ã‚¿ã‚°å‰Šé™¤ / Delete Tag</h3><p id="delDateInfo"></p><input type="range" id="delSlider" style="width:100%" step="25" min="25"><div style="margin:15px 0;"><label><input type="checkbox" id="delAllCheck" onchange="toggleDelAll(this)"> å…¨ã¦å‰Šé™¤ / Delete All</label></div><div style="display:flex; gap:10px;"><button class="btn-tool" style="flex:1; background:#ccc;" onclick="closeDeleteModal()">æˆ»ã‚‹ / Back</button><button class="btn-tool" style="background:#ff4757; flex:1;" onclick="executeDelete()">å®Ÿè¡Œ / Delete</button></div></div></div>

<script>
    const STUDY_TIME = 25 * 60;
    const BREAK_TIME = 5 * 60;
    let timeLeft = STUDY_TIME;
    let timerIdx = null;
    let isBreak = false;

    let users = JSON.parse(localStorage.getItem('focus_master_users')) || { "default": { name: "ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ", stats: {}, tags: [] } };
    let activeUserId = localStorage.getItem('focus_master_active_user') || "default";

    if (localStorage.getItem('focus_master_stats') && activeUserId === "default" && Object.keys(users.default.stats).length === 0) {
        users.default.stats = JSON.parse(localStorage.getItem('focus_master_stats'));
        users.default.tags = JSON.parse(localStorage.getItem('focus_master_tags')) || [];
        localStorage.setItem('focus_master_users', JSON.stringify(users));
    }

    let dailyStats = users[activeUserId].stats;
    let tagHistory = users[activeUserId].tags;

    let currentRange = 7;
    let myChart = null, pieChart = null, lineChart = null;
    let audioCtx = null;
    let selectedTag = null, selectedDate = null;
    let wakeLock = null;

    async function requestWakeLock() {
        if ('wakeLock' in navigator) {
            try { 
                wakeLock = await navigator.wakeLock.request('screen');
            } catch (err) { 
                console.error(`${err.name}, ${err.message}`); 
            }
        }
    }

    function releaseWakeLock() {
        if (wakeLock !== null) { wakeLock.release(); wakeLock = null; }
    }

    // ã‚¿ãƒ–ãŒåˆ‡ã‚Šæ›¿ã‚ã£ãŸã‚Šã‚¹ãƒãƒ›ãŒã‚¹ãƒªãƒ¼ãƒ—ã‹ã‚‰æˆ»ã£ãŸæ™‚ã«Wake Lockã‚’å†è¦æ±‚ã™ã‚‹
    document.addEventListener('visibilitychange', async () => {
        if (timerIdx !== null && document.visibilityState === 'visible') {
            await requestWakeLock();
        }
    });

    function jumpTo(id) { document.getElementById(id).scrollIntoView({ behavior: 'smooth' }); }
    function toggleCustomRange() { const box = document.getElementById('customRangeBox'); box.style.display = (box.style.display === 'flex') ? 'none' : 'flex'; }

    function applyCustomRange() {
        const start = document.getElementById('startDate').value;
        const end = document.getElementById('endDate').value;
        if (!start || !end) return alert("æœŸé–“ã‚’æ­£ã—ãé¸æŠã—ã¦ãã ã•ã„ / Invalid Range");
        currentRange = 'custom';
        renderAllCharts(start, end);
    }

    function renderAllCharts(cStart = null, cEnd = null) {
        const labels = []; const chartDates = [];
        const datasetsMap = {}; const categoryTotals = {};
        let rangeTotal = 0, actualActiveDays = 0;

        if (cStart && cEnd) {
            let curr = new Date(cStart); const stop = new Date(cEnd);
            while (curr <= stop) {
                const ds = curr.toISOString().split('T')[0];
                chartDates.push(ds); labels.push(`${curr.getMonth()+1}/${curr.getDate()}`);
                
                let dayHasData = false;
                tagHistory.forEach(tag => {
                    if (!datasetsMap[tag]) datasetsMap[tag] = [];
                    const val = (dailyStats[ds] && dailyStats[ds][tag]) || 0;
                    datasetsMap[tag].push(val);
                    rangeTotal += val;
                    categoryTotals[tag] = (categoryTotals[tag] || 0) + val;
                    if(val > 0) dayHasData = true;
                });
                if(dayHasData) actualActiveDays++;
                curr.setDate(curr.getDate() + 1);
            }
        } else {
            const end = new Date();
            for (let i = currentRange - 1; i >= 0; i--) {
                const d = new Date(); d.setDate(end.getDate() - i);
                const ds = d.toISOString().split('T')[0];
                chartDates.push(ds); labels.push(`${d.getMonth()+1}/${d.getDate()}`);
                
                let dayHasData = false;
                tagHistory.forEach(tag => {
                    if (!datasetsMap[tag]) datasetsMap[tag] = [];
                    const val = (dailyStats[ds] && dailyStats[ds][tag]) || 0;
                    datasetsMap[tag].push(val);
                    rangeTotal += val;
                    categoryTotals[tag] = (categoryTotals[tag] || 0) + val;
                    if(val > 0) dayHasData = true;
                });
                if(dayHasData) actualActiveDays++;
            }
        }

        updateDashboard(rangeTotal, actualActiveDays);
        drawBarChart(labels, chartDates, datasetsMap);
        drawPieChart(categoryTotals);
        drawLineChart(labels, datasetsMap);
    }

    function updateDashboard(total, activeDays) {
        document.getElementById('totalMinutes').innerText = total;
        document.getElementById('activeDays').innerText = activeDays;
        document.getElementById('streakDays').innerText = calculateStreak();
        document.getElementById('activeUserName').innerText = users[activeUserId].name;
    }

    function drawBarChart(labels, chartDates, datasetsMap) {
        const ctx = document.getElementById('pomoChart').getContext('2d');
        const datasets = Object.keys(datasetsMap).map((tag, idx) => ({
            label: tag, data: datasetsMap[tag], backgroundColor: `hsl(${idx * 137.5}, 70%, 60%)`, borderRadius: 4
        }));
        if (myChart) myChart.destroy();
        myChart = new Chart(ctx, {
            type: 'bar', data: { labels, datasets },
            options: { 
                responsive: true, maintainAspectRatio: false, scales: { x: { stacked: true }, y: { stacked: true } },
                onClick: (e, elements) => {
                    if (elements.length > 0) {
                        const { datasetIndex, index } = elements[0];
                        selectedTag = myChart.data.datasets[datasetIndex].label;
                        selectedDate = chartDates[index];
                        const btn = document.getElementById('delTargetBtn');
                        btn.style.display = 'block'; btn.textContent = `ğŸ—‘ ${selectedDate} [${selectedTag}] å‰Šé™¤ / Delete`;
                    }
                }
            }
        });
    }

    function drawPieChart(catTotals) {
        const ctx = document.getElementById('pieChart').getContext('2d');
        const tags = Object.keys(catTotals).filter(t => catTotals[t] > 0);
        if (pieChart) pieChart.destroy();
        const chartData = tags.map(t => catTotals[t]);
        const chartColors = tags.map((tag) => {
            const idx = tagHistory.indexOf(tag);
            return `hsl(${idx * 137.5}, 70%, 60%)`;
        });
        pieChart = new Chart(ctx, {
            type: 'doughnut',
            data: { labels: tags, datasets: [{ data: chartData, backgroundColor: chartColors }] },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { boxWidth: 12 } } } }
        });
    }

    function drawLineChart(labels, datasetsMap) {
        const ctx = document.getElementById('lineChart').getContext('2d');
        const datasets = Object.keys(datasetsMap).map((tag, idx) => ({
            label: tag, data: datasetsMap[tag], borderColor: `hsl(${idx * 137.5}, 70%, 60%)`, tension: 0.3, pointRadius: 2
        }));
        if (lineChart) lineChart.destroy();
        lineChart = new Chart(ctx, {
            type: 'line', data: { labels, datasets },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
        });
    }

    function initAudio() { if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
    function toggleTimer() {
        initAudio(); const btn = document.getElementById('startBtn');
        if (timerIdx) { clearInterval(timerIdx); timerIdx = null; btn.textContent = "å†é–‹ / Resume"; releaseWakeLock(); }
        else {
            btn.textContent = "ä¸€æ™‚åœæ­¢ / Pause";
            requestWakeLock();
            timerIdx = setInterval(() => {
                timeLeft--; updateTimerDisplay();
                if (timeLeft <= 0) { clearInterval(timerIdx); timerIdx = null; startAlarm(); releaseWakeLock(); }
            }, 1000);
        }
    }
    function updateTimerDisplay() {
        const m = Math.floor(timeLeft / 60); const s = timeLeft % 60;
        document.getElementById('timerDisplay').textContent = `${m.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
    }
    function startAlarm() { 
        document.getElementById('alarmTitle').textContent = isBreak ? "ä¼‘æ†©çµ‚äº†ï¼ / Break Over" : "é›†ä¸­çµ‚äº†ï¼ / Focus Done"; 
        document.getElementById('alarmModal').style.display='flex'; 
    }
    function stopAlarm() { document.getElementById('alarmModal').style.display='none'; handleTimerEnd(); }
    function handleTimerEnd() {
        const tag = document.getElementById('studyTag').value.trim() || "ãã®ä»– / Others";
        const today = new Date().toISOString().split('T')[0];
        if (!isBreak) {
            if (!dailyStats[today]) dailyStats[today] = {};
            dailyStats[today][tag] = (dailyStats[today][tag] || 0) + 25;
            if (!tagHistory.includes(tag)) tagHistory.push(tag);
            save(); isBreak = true; timeLeft = BREAK_TIME;
        } else { isBreak = false; timeLeft = STUDY_TIME; }
        renderAllCharts(); updateTagList(); updateTimerDisplay();
        document.getElementById('startBtn').textContent = "ã‚¹ã‚¿ãƒ¼ãƒˆï¼ / START";
    }

    function save() { 
        users[activeUserId].stats = dailyStats;
        users[activeUserId].tags = tagHistory;
        localStorage.setItem('focus_master_users', JSON.stringify(users)); 
        localStorage.setItem('focus_master_active_user', activeUserId);
    }

    function openUserModal() {
        const container = document.getElementById('userListContainer');
        container.innerHTML = Object.keys(users).map(id => `
            <div style="padding:12px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:${id === activeUserId ? '#f0f7ff' : 'transparent'}">
                <span style="font-weight:bold; color:${id === activeUserId ? 'var(--primary)' : '#333'}; cursor:pointer;" onclick="switchUser('${id}')">${users[id].name} ${id === activeUserId ? ' (é¸æŠä¸­)' : ''}</span>
                ${id !== 'default' ? `<button class="btn-tool" style="background:#ff4757; padding:5px 10px;" onclick="deleteUser('${id}')">å‰Šé™¤</button>` : ''}
            </div>`).join('');
        document.getElementById('userModal').style.display = 'flex';
    }
    function closeUserModal() { document.getElementById('userModal').style.display = 'none'; }

    function addNewUser() {
        const name = prompt("ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ / Enter User Name:");
        if (name && name.trim()) {
            const id = "user_" + Date.now();
            users[id] = { name: name.trim(), stats: {}, tags: [] };
            save();
            switchUser(id);
            closeUserModal();
        }
    }

    function switchUser(id) {
        if (timerIdx) { alert("ã‚¿ã‚¤ãƒãƒ¼ç¨¼åƒä¸­ã¯åˆ‡ã‚Šæ›¿ãˆã‚‰ã‚Œã¾ã›ã‚“ / Timer is running"); return; }
        activeUserId = id;
        dailyStats = users[activeUserId].stats;
        tagHistory = users[activeUserId].tags;
        save();
        renderAllCharts();
        updateTagList();
        closeUserModal();
    }

    function renameCurrentUser() {
        const currentName = users[activeUserId].name;
        const newName = prompt("æ–°ã—ã„ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ / New User Name:", currentName);
        if (newName && newName.trim() && newName.trim() !== currentName) {
            users[activeUserId].name = newName.trim();
            save();
            updateDashboard(document.getElementById('totalMinutes').innerText, document.getElementById('activeDays').innerText);
        }
    }

    function deleteUser(id) {
        if (id === 'default') return;
        if (confirm(`ãƒ¦ãƒ¼ã‚¶ãƒ¼ã€Œ${users[id].name}ã€ã®ãƒ‡ãƒ¼ã‚¿ã‚’å®Œå…¨ã«å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ`)) {
            if (activeUserId === id) switchUser('default');
            delete users[id];
            save();
            openUserModal();
        }
    }

    function exportData() { const blob = new Blob([JSON.stringify(users)], {type:'application/json'}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = 'focus_backup_all_users.json'; a.click(); }
    function importData(e) {
        const reader = new FileReader();
        reader.onload = (ev) => { 
            try {
                const data = JSON.parse(ev.target.result);
                if (data.stats && data.tags) {
                    users[activeUserId].stats = data.stats;
                    users[activeUserId].tags = data.tags;
                } else {
                    users = data;
                    activeUserId = Object.keys(users)[0];
                }
                dailyStats = users[activeUserId].stats;
                tagHistory = users[activeUserId].tags;
                save(); renderAllCharts(); updateTagList(); alert("å¾©å…ƒå®Œäº† / Restored");
            } catch(e) { alert("ãƒ•ã‚¡ã‚¤ãƒ«å½¢å¼ãŒæ­£ã—ãã‚ã‚Šã¾ã›ã‚“"); }
        };
        reader.readAsText(e.target.files[0]);
    }

    function changeRange(d, btn) { currentRange = d; document.getElementById('customRangeBox').style.display='none'; renderAllCharts(); }

    function calculateStreak() {
        const dates = Object.keys(dailyStats).filter(d => {
            const dayData = dailyStats[d];
            return dayData && Object.values(dayData).some(v => v > 0);
        }).sort().reverse();
        if (dates.length === 0) return 0;
        const todayStr = new Date().toISOString().split('T')[0];
        const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        if (dates[0] !== todayStr && dates[0] !== yesterdayStr) return 0;
        let streak = 0; let checkDate = new Date(dates[0]);
        while (true) {
            const ds = checkDate.toISOString().split('T')[0];
            if (dailyStats[ds] && Object.values(dailyStats[ds]).some(val => val > 0)) {
                streak++; checkDate.setDate(checkDate.getDate() - 1);
            } else break;
        }
        return streak;
    }

    function updateTagList() { document.getElementById('tagHistory').innerHTML = tagHistory.map(t => `<option value="${t}">`).join(''); }
    function openTagManager() {
        const container = document.getElementById('tagListContainer');
        container.innerHTML = tagHistory.map(t => `
            <div style="padding:12px; border-bottom:1px solid #eee; display:flex; flex-direction:column; gap:8px;">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <span style="font-weight:bold; color:var(--primary); cursor:pointer;" onclick="document.getElementById('studyTag').value='${t}'; closeTagManager()">${t}</span>
                    <div style="display:flex; gap:5px;">
                        <button class="btn-tool" style="background:#f39c12; padding:5px 10px;" onclick="renameTag('${t}')">ç·¨é›† / Edit</button>
                        <button class="btn-tool" style="background:#ff4757; padding:5px 10px;" onclick="deleteTagHistory('${t}')">å‰Šé™¤ / Del</button>
                    </div>
                </div>
            </div>`).join('');
        document.getElementById('tagManagerModal').style.display='flex';
    }
    function closeTagManager() { document.getElementById('tagManagerModal').style.display='none'; }
    function addNewTag() { const t = prompt("æ–°è¦ã‚¿ã‚°å / New Tag Name:"); if(t && !tagHistory.includes(t.trim())){ tagHistory.push(t.trim()); save(); updateTagList(); openTagManager(); } }
    
    function renameTag(oldTag) {
        const newTag = prompt(`ã€Œ${oldTag}ã€ã®æ–°ã—ã„åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ / New name for "${oldTag}":`, oldTag);
        if (!newTag || newTag.trim() === "" || newTag.trim() === oldTag) return;
        const trimmedNewTag = newTag.trim();
        if (tagHistory.includes(trimmedNewTag)) {
            if (!confirm(`ã€Œ${trimmedNewTag}ã€ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™ã€‚ãƒ‡ãƒ¼ã‚¿ã‚’çµ±åˆã—ã¾ã™ã‹ï¼Ÿ / Already exists. Merge?`)) return;
        }
        for (let date in dailyStats) {
            if (dailyStats[date][oldTag] !== undefined) {
                const value = dailyStats[date][oldTag];
                dailyStats[date][trimmedNewTag] = (dailyStats[date][trimmedNewTag] || 0) + value;
                delete dailyStats[date][oldTag];
            }
        }
        tagHistory = tagHistory.filter(t => t !== oldTag);
        if (!tagHistory.includes(trimmedNewTag)) tagHistory.push(trimmedNewTag);
        save(); renderAllCharts(); updateTagList(); openTagManager();
    }

    function deleteTagHistory(t) { if(confirm(`${t} ã®çµ±è¨ˆã‚‚å«ã‚ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ / Delete all stats for "${t}"?`)){ tagHistory = tagHistory.filter(x => x!==t); for(let d in dailyStats) delete dailyStats[d][t]; save(); renderAllCharts(); openTagManager(); } }
    function openDeleteModal() { const max = dailyStats[selectedDate][selectedTag]; document.getElementById('delDateInfo').textContent = `${selectedDate} [${selectedTag}]`; const slider = document.getElementById('delSlider'); slider.max = max; slider.value = 25; document.getElementById('deleteModal').style.display = 'flex'; }
    function closeDeleteModal() { document.getElementById('deleteModal').style.display = 'none'; }
    function executeDelete() { const val = parseInt(document.getElementById('delSlider').value); dailyStats[selectedDate][selectedTag] -= val; if(dailyStats[selectedDate][selectedTag] <= 0) delete dailyStats[selectedDate][selectedTag]; save(); renderAllCharts(); closeDeleteModal(); document.getElementById('delTargetBtn').style.display = 'none'; }
    function toggleDelAll(chk) { if(chk.checked) document.getElementById('delSlider').value = document.getElementById('delSlider').max; }

    window.onload = () => { 
        updateTagList(); 
        document.getElementById('endDate').value = new Date().toISOString().split('T')[0];
        renderAllCharts(); 
    };
</script>
</body>
</html>
